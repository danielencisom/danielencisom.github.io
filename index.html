<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<meta name="theme-color" content="#1976D2" />
<title>Registro de Equipos de CÃ³mputo - PRO</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<!-- QuaggaJS -->
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
<style>
:root{
    --primary-color:#1976D2;
    --secondary-color:#4CAF50;
    --danger-color:#D32F2F;
    --background-light:#f4f6f9;
    --surface-light:#ffffff;
    --text-dark:#333;
    --border-color:#ddd;
    --invalid-color:#f44336;
    --overlay-bg: rgba(0,0,0,0.45);
}
html,body{height:100%;margin:0;padding:0;background:var(--background-light);font-family:'Roboto',Arial,sans-serif;color:var(--text-dark);-webkit-overflow-scrolling:touch;}
.outer{display:flex;justify-content:center;padding:18px;}
.container{width:100%;max-width:980px;margin:0 auto;max-height:calc(100vh - 36px);overflow-y:auto;padding-bottom:24px;}
h1{color:var(--primary-color);text-align:center;margin-bottom:18px;font-weight:700;}
.card{background:var(--surface-light);padding:16px;border-radius:8px;margin-bottom:18px;box-shadow:0 4px 10px rgba(0,0,0,0.06);}
.form-group{margin-bottom:12px;}
label{display:block;margin-bottom:6px;font-weight:500;font-size:0.95em;}
input[type="text"], select{padding:10px 12px;border:1px solid var(--border-color);border-radius:4px;width:100%;box-sizing:border-box;font-size:1em;transition:border-color .25s,box-shadow .25s;}
input[type="text"]:focus, select:focus{border-color:var(--primary-color);outline:none;box-shadow:0 0 0 3px rgba(25,118,210,0.08);}
.input-invalid{border-color:var(--invalid-color) !important;box-shadow:0 0 0 3px rgba(244,67,54,0.12) !important;}
.input-with-button{display:flex;align-items:center;border:1px solid var(--border-color);border-radius:4px;overflow:hidden;}
.input-with-button input{border:none;flex-grow:1;padding:10px 12px;font-size:1em;}
.scan-btn{background-color:var(--primary-color);color:white;border:none;padding:10px 15px;cursor:pointer;font-size:1.1em;line-height:1;}
.scan-btn:hover{background-color:#1565C0;}
.btn-action{border:none;padding:12px 20px;margin-top:12px;border-radius:6px;cursor:pointer;font-size:1em;font-weight:500;width:100%;transition:background-color .2s;background-color:var(--secondary-color);color:var(--surface-light);}
.btn-action:hover{background-color:#388E3C;}
.btn-danger{background-color:var(--danger-color);color:var(--surface-light);width:100%;padding:10px;margin-top:10px;border:none;border-radius:4px;cursor:pointer;}
.btn-danger:hover{background-color:#C62828;}
#listaComponentes{list-style:none;padding:0;margin:0;}
#listaComponentes li{background:#e3f2fd;margin-bottom:8px;padding:10px;border-left:5px solid var(--primary-color);border-radius:4px;font-size:0.95em;}
#resumenKit{background:#e0f2f1;border-left:5px solid var(--secondary-color);}
#video-container{margin-top:12px;position:relative;width:100%;height:300px;overflow:hidden;background:#000;border-radius:4px;}
#video-container video,#video-container canvas{max-width:100%;width:100%;height:100%;display:block;object-fit:cover;position:absolute;top:0;left:0;}
.dynamic-fields{display:grid;grid-template-columns:1fr;gap:12px;margin-top:4px;}
.responsable-group{display:flex;gap:10px;}
.responsable-group select{width:30%;flex-shrink:0;}
.full-width-field{grid-column:1 / -1;}
#message-box{display:none;padding:10px;border-radius:6px;margin-bottom:12px;font-weight:500;}
.msg-error{background:#ffeeee;color:var(--danger-color);border-left:5px solid var(--danger-color);}
.msg-success{background:#e8f5e9;color:var(--secondary-color);border-left:5px solid var(--secondary-color);}
.msg-info{background:#e3f2fd;color:var(--primary-color);border-left:5px solid var(--primary-color);}
@media (min-width:768px){.dynamic-fields{grid-template-columns:1fr 1fr}.dynamic-fields.stacked>.form-group{grid-column:1 / -1;}}
@media (max-width:420px){.scan-btn{padding:12px 14px;font-size:1.15em}.btn-action{padding:14px;font-size:1.05em}}
.overlay{position:fixed;left:0;right:0;top:0;bottom:0;background:var(--overlay-bg);display:flex;align-items:center;justify-content:center;z-index:9999;display:none;}
.loader-card{width:90%;max-width:420px;background:#fff;padding:18px;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,0.25);text-align:center;}
.loader-title{font-weight:600;color:var(--primary-color);margin-bottom:12px;}
.progress{height:10px;background:#eee;border-radius:999px;overflow:hidden;margin:12px 0;}
.progress-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--primary-color),#63a4ff);transition:width 0.45s ease;}
.loader-sub{text-transform:uppercase;font-size:0.85em;color:#666;margin-top:6px;}
.video-controls{position:absolute;right:10px;top:10px;z-index:20;display:flex;gap:8px;align-items:center;}
.small-btn{background:rgba(0,0,0,0.45);border:1px solid rgba(255,255,255,0.12);color:#fff;padding:8px;border-radius:8px;cursor:pointer;}
.small-btn:hover{background:rgba(0,0,0,0.6);}
@keyframes shake {0%{transform:translateX(0);}20%{transform:translateX(-6px);}40%{transform:translateX(6px);}60%{transform:translateX(-4px);}80%{transform:translateX(4px);}100%{transform:translateX(0);}}
.input-shake{animation:shake 520ms ease-in-out;}
.input-invalid{border-color:var(--invalid-color) !important;box-shadow:0 0 0 4px rgba(244,67,54,0.12) !important;}
.input-with-button.input-invalid{border-color:var(--invalid-color) !important;box-shadow:0 0 0 4px rgba(244,67,54,0.12) !important;}
.overlay.show{display:flex;animation:overlayFade .28s ease forwards;}
@keyframes overlayFade{from{opacity:0;}to{opacity:1;}}
.progress-bar{transition:width 420ms cubic-bezier(0.2,0.9,0.2,1);}
.field-error{color:var(--invalid-color);font-size:0.85em;margin-top:6px;display:block;font-weight:500;}
.scan-frame{position:absolute;top:35%;left:20%;width:60%;height:30%;border:3px solid rgba(0,255,0,0.8);box-shadow:0 0 20px rgba(0,255,0,0.4);z-index:10;pointer-events:none;border-radius:8px;transition:all 0.4s ease;}
</style>
</head>
<body>
<div class="outer">
  <div class="container" role="main">
    <h1>REGISTRO DE EQUIPOS DE CÃ“MPUTO</h1>
    <div id="message-box" class="card" aria-live="polite"></div>

    <div class="card">
      <h2>InformaciÃ³n General del KIT y UbicaciÃ³n</h2>
      <div class="form-group">
        <label for="codigoKitUsuario">CÃ³digo del KIT:</label>
        <input type="text" id="codigoKitUsuario" value="KIT-0001" readonly />
      </div>

      <div class="form-group">
        <label for="estado">ðŸ“Œ Estado del Equipo:*</label>
        <select id="estado" required>
          <option value="">Seleccione...</option>
          <option value="Operativo">Operativo</option>
          <option value="De Baja">De Baja</option>
          <option value="Pendiente">Pendiente</option>
        </select>
      </div>

      <div class="form-group">
        <label for="tecnicoResponsable">TÃ©cnico Responsable:*</label>
        <select id="tecnicoResponsable" required>
          <option value="">Seleccione...</option>
          <option value="CH">CARLOS HUACHO</option>
          <option value="JI">JOSUE IBAÃ‘EZ</option>
          <option value="DE">DANIEL ENCISO</option>
          <option value="OO">ODAR OLAYA</option>
          <option value="JL">JOSE LUYO</option>
          <option value="SC">SANTIAGO CARPIO</option>
          <option value="DC">DAVID COTERA</option>
        </select>
      </div>

      <div class="form-group">
        <label for="sede">Sede:*</label>
        <select id="sede" required>
          <option value="">Seleccione...</option>
          <option value="SS12">SEDE SAENZ PEÃ‘A 120</option>
          <option value="SS17">SEDE SAENZ PEÃ‘A 175-177-181</option>
          <option value="SS15">SEDE SAENZ PEÃ‘A 155-157</option>
          <option value="SS18">SEDE KING 1</option>
          <option value="SS19">SEDE KING 2</option>
          <option value="SS20">SEDE GRAU</option>
        </select>
      </div>

      <div class="form-group">
        <label for="dependencia">Dependencia:*</label>
        <select id="dependencia" required>
          <option value="">-- Seleccionar --</option>
          <option value="Lima">Lima</option>
          <option value="Callao">Callao</option>
          <option value="Cusco">Cusco</option>
        </select>
      </div>
    </div>

    <div class="card">
      <h2>InformaciÃ³n de Usuario Responsable de KIT</h2>
      <div class="form-group">
        <label for="tipoCargo">TIPO DE CARGO:*</label>
        <select id="tipoCargo" required>
          <option value="">Seleccione...</option>
          <option value="ASD">ASISTENTE ADMINISTRATIVO</option>
          <option value="AFF">ASISTENTE FUNCION FISCAL</option>
          <option value="AUD">AUXILIAR ADMINISTRATIVO</option>
          <option value="COOR">COORDINADOR</option>
          <option value="EA">ESPECIALISTA ADMINISTRATIVO</option>
          <option value="FAF">FISCAL ADJUNTO FISCAL</option>
          <option value="OAD">OPERADOR ADMINISTRATIVO</option>
          <option value="PRO">PROGRAMADOR</option>
          <option value="SEC">SECIGRISTA</option>
          <option value="TAD">TECNICO ADMINISTRATIVO</option>
          <option value="TER">TERCERO</option>
          <option value="VOL">VOLUNTARIO</option>
        </select>
      </div>
      <div id="camposDinamicos" class="dynamic-fields"></div>
      <div class="form-group" id="anexo-group">
        <label for="anexoKit">NÂ° de Anexo (TelÃ©fono - Solo 5 nÃºmeros):</label>
        <input type="text" id="anexoKit" placeholder="Escriba el NÂ° de Anexo (e.g., 12345)" pattern="\d{5}" maxlength="5" />
      </div>
    </div>

    <div class="card">
      <h2>Registro de Componentes</h2>
      <div class="form-group">
        <label for="tipoComponente">Seleccionar Componente:*</label>
        <select id="tipoComponente">
          <option value="">-- Seleccionar --</option>
          <option value="cpu">CPU</option>
          <option value="laptop">Laptop</option>
          <option value="monitor">Monitor</option>
          <option value="teclado">Teclado</option>
          <option value="docking">Docking</option>
          <optgroup label="PerifÃ©ricos">
            <option value="fotocopiadora">Fotocopiadora</option>
            <option value="impresora">Impresora Multifuncional</option>
            <option value="escaner">EscÃ¡ner</option>
            <option value="ups">UPS</option>
            <option value="camaraweb">CÃ¡mara Web</option>
            <option value="mouse">Mouse</option>
          </optgroup>
        </select>
      </div>

      <div class="card" id="formularioComponente" style="display:none;padding:12px;background:#f9f9f9;box-shadow:none;">
        <div class="form-group" id="codigoKitCompContainer">
          <label for="codigoKitComp">CÃ³digo del KIT del Componente:</label>
          <input type="text" id="codigoKitComp" readonly />
        </div>

        <div class="form-group" id="ip-group" style="display:none;">
          <label for="ip">DirecciÃ³n IP:</label>
          <input type="text" id="ip" placeholder="DirecciÃ³n IP (e.g., 192.168.1.100)" />
        </div>

        <div class="form-group" id="marguesi-group" style="display:none;">
          <label>ðŸ“Œ COD. MARGUESI:*</label>
          <div class="input-with-button">
            <input id="marguesi" type="text" class="scanable" placeholder="Escanea o escribe el cÃ³digo de barras" autocomplete="off" />
            <button class="scan-btn" data-input-id="marguesi" type="button">ðŸ“·</button>
          </div>
        </div>

        <div class="form-group" id="nro_serie-group" style="display:none;">
          <label for="nro_serie">ðŸ“Œ NÂ° SERIE:*</label>
          <input type="text" id="nro_serie" placeholder="Escribe el NÃºmero de Serie" />
        </div>

        <div id="video-container" style="display:none;">
          <div class="video-controls" aria-hidden="false">
            <button id="switch-camera" class="small-btn" title="Cambiar cÃ¡mara">â†º</button>
            <button id="toggle-torch" class="small-btn" title="Linterna">ðŸ”¦</button>
          </div>
          <div class="scan-frame"></div>
        </div>
        <button id="retry-btn" class="btn-danger" style="display:none;" type="button">Volver a intentar escaneo</button>

        <div class="form-group" id="patrimonial-group" style="display:none;">
          <label for="patrimonial">COD. PATRIMONIAL (Opcional):</label>
          <input type="text" id="patrimonial" placeholder="CÃ³digo Patrimonial" />
        </div>

        <div class="form-group" id="marca-group" style="display:none;">
          <label for="marca">ðŸ“Œ Marca:*</label>
          <input type="text" id="marca" placeholder="Marca del componente" />
        </div>

        <div class="form-group" id="modelo-group" style="display:none;">
          <label for="modelo">ðŸ“Œ Modelo:*</label>
          <input type="text" id="modelo" placeholder="Modelo del componente" />
        </div>

        <button class="btn-action" id="add-component" type="button">Agregar Componente</button>
      </div>
    </div>

    <div class="card">
      <h3>Componentes aÃ±adidos al KIT</h3>
      <ul id="listaComponentes"></ul>
    </div>

    <div class="card" id="resumenKit" style="display:none;">
      <h3>Resumen del KIT</h3>
      <p><strong>KIT y Titular:</strong> <span id="kitFinal"></span></p>
      <h4>Componentes Registrados:</h4>
      <ul id="componentesResumenLista" style="list-style-type:none;padding-left:0;"></ul>
    </div>

    <button class="btn-action" id="send-form" style="margin-bottom:26px;" type="button">Enviar KIT a Registro</button>

  </div>
</div>

<div id="overlay" class="overlay" aria-hidden="true">
  <div class="loader-card" role="status" aria-live="polite">
    <div class="loader-title">Enviando datos...</div>
    <div class="progress"><div id="progress-bar" class="progress-bar"></div></div>
    <div id="loader-sub" class="loader-sub">Conectando con servidor...</div>
  </div>
</div>

<script>
/* -------------------------
  App: Registro de Equipos (RECONSTRUIDO - PRO)
  IntegraciÃ³n: QuaggaJS PRO + UI + Autosave + EnvÃ­o
---------------------------*/

const SHEET_URL = "https://script.google.com/macros/s/AKfycbzAK7pa6QFlDboMxXjMYjsBqIl03NWlt67LDeEoFEN1aZvjGRZYpjCGHplrKSqY1Mxb/exec";

const state = {
    contador: { cpu:1, monitor:1, teclado:1, laptop:1, docking:1, ups:1, camaraweb:1, mouse:1 },
    componentes: [],
    scanning: false,
    activeInput: null,
    currentFacingMode: 'environment',
    torchAvailable: false,
    lastScanTimestamp: 0
};

const dom = {
    messageBox: document.getElementById('message-box'),
    tipoCargo: document.getElementById('tipoCargo'),
    camposDinamicos: document.getElementById('camposDinamicos'),
    tipoComponente: document.getElementById("tipoComponente"),
    formularioComponente: document.getElementById("formularioComponente"),
    codigoKitUsuario: document.getElementById("codigoKitUsuario"),
    codigoKitCompContainer: document.getElementById("codigoKitCompContainer"),
    codigoKitComp: document.getElementById("codigoKitComp"),
    marguesi: document.getElementById("marguesi"),
    nro_serie: document.getElementById("nro_serie"),
    marca: document.getElementById("marca"),
    modelo: document.getElementById("modelo"),
    listaComponentes: document.getElementById("listaComponentes"),
    resumenKit: document.getElementById("resumenKit"),
    kitFinal: document.getElementById("kitFinal"),
    videoContainer: document.getElementById('video-container'),
    retryBtn: document.getElementById('retry-btn'),
    scanableInputs: null,
    tecnicoResponsable: null,
    sede: null,
    dependencia: null,
    estado: null,
    anexoKit: null,
    overlay: document.getElementById('overlay'),
    progressBar: document.getElementById('progress-bar'),
    loaderSub: document.getElementById('loader-sub'),
    switchCameraBtn: document.getElementById('switch-camera'),
    toggleTorchBtn: document.getElementById('toggle-torch')
};

function beep(duration = 0.05, frequency = 880, volume = 0.05) {
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.value = frequency;
        g.gain.value = volume;
        o.connect(g);
        g.connect(ctx.destination);
        o.start(0);
        setTimeout(()=>{ o.stop(); ctx.close(); }, duration*1000);
    } catch(e){}
}

function showMessage(message, type='error') {
    dom.messageBox.textContent = message;
    dom.messageBox.className = 'card';
    dom.messageBox.classList.add(`msg-${type}`);
    dom.messageBox.style.display = 'block';
    if (type !== 'info') {
        setTimeout(()=>{ if(dom.messageBox.textContent === message) dom.messageBox.style.display='none'; },4500);
    }
}

/* Autosave */
const LS_KEY = 'registro_equipos_autosave_v1';
const LS_PENDING_SUBMISSIONS = 'registro_equipos_pending_submissions_v1';

function autosave() {
    try {
        const nombreResponsableInput = document.getElementById('nombreResponsable');
        const tipoResponsableInput = document.getElementById('tipoResponsable');
        const usuarioFinalNameInput = document.getElementById('usuarioFinalName');
        const ipInput = document.getElementById('ip');
        const patrimonialInput = document.getElementById('patrimonial');
        const marcaInput = document.getElementById('marca');
        const modeloInput = document.getElementById('modelo');
        const marguesiInput = document.getElementById('marguesi');
        const nroSerieInput = document.getElementById('nro_serie');
        const codigoKitCompInput = document.getElementById('codigoKitComp');
        const tipoComponenteInput = document.getElementById('tipoComponente');

        const payload = {
            form: {
                codigoKitUsuario: dom.codigoKitUsuario.value,
                estado: dom.estado ? dom.estado.value : '',
                tecnicoResponsable: dom.tecnicoResponsable ? dom.tecnicoResponsable.value : '',
                sede: dom.sede ? dom.sede.value : '',
                dependencia: dom.dependencia ? dom.dependencia.value : '',
                anexoKit: dom.anexoKit ? dom.anexoKit.value : '',
                tipoCargo: dom.tipoCargo.value,
                nombreResponsable: (nombreResponsableInput||{}).value||'',
                tipoResponsable: (tipoResponsableInput||{}).value||'',
                usuarioFinalName: (usuarioFinalNameInput||{}).value||'',
                ip: (ipInput||{}).value||'',
                patrimonial: (patrimonialInput||{}).value||'',
                marca: (marcaInput||{}).value||'',
                modelo: (modeloInput||{}).value||'',
                marguesi: (marguesiInput||{}).value||'',
                nro_serie: (nroSerieInput||{}).value||'',
                codigoKitComp: (codigoKitCompInput||{}).value||'',
                tipoComponente: (tipoComponenteInput||{}).value||''
            },
            componentes: state.componentes,
            contador: state.contador,
            timestamp: Date.now()
        };
        localStorage.setItem(LS_KEY, JSON.stringify(payload));
    } catch(e){ console.warn('Autosave failed', e); }
}

function restoreAutosave() {
    try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return;
        const payload = JSON.parse(raw);
        if (!payload) return;
        const f = payload.form || {};
        if (f.estado && dom.estado) dom.estado.value = f.estado;
        if (f.tecnicoResponsable && dom.tecnicoResponsable) dom.tecnicoResponsable.value = f.tecnicoResponsable;
        if (f.sede && dom.sede) dom.sede.value = f.sede;
        if (f.dependencia && dom.dependencia) dom.dependencia.value = f.dependencia;
        if (f.anexoKit && dom.anexoKit) dom.anexoKit.value = f.anexoKit;
        if (f.tipoCargo) dom.tipoCargo.value = f.tipoCargo;
        if (f.tipoCargo) mostrarCampos();
        setTimeout(()=>{
            if (f.nombreResponsable) { const el = document.getElementById('nombreResponsable'); if(el) el.value = f.nombreResponsable; }
            if (f.tipoResponsable) { const el = document.getElementById('tipoResponsable'); if(el) el.value = f.tipoResponsable; }
            if (f.usuarioFinalName) { const el = document.getElementById('usuarioFinalName'); if(el) el.value = f.usuarioFinalName; }
            if (f.tipoComponente) {
                dom.tipoComponente.value = f.tipoComponente;
                mostrarFormulario(false);
                if (f.ip) { const el = document.getElementById('ip'); if(el) el.value = f.ip; }
                if (f.patrimonial) { const el = document.getElementById('patrimonial'); if(el) el.value = f.patrimonial; }
                if (f.marca) { const el = document.getElementById('marca'); if(el) el.value = f.marca; }
                if (f.modelo) { const el = document.getElementById('modelo'); if(el) el.value = f.modelo; }
                if (f.marguesi) { const el = document.getElementById('marguesi'); if(el) el.value = f.marguesi; }
                if (f.nro_serie) { const el = document.getElementById('nro_serie'); if(el) el.value = f.nro_serie; }
            }
            state.componentes = payload.componentes || [];
            const defaultContador = { cpu:1, monitor:1, teclado:1, laptop:1, docking:1, ups:1, camaraweb:1, mouse:1 };
            state.contador = { ...defaultContador, ...(payload.contador || {}) };
            refreshComponentList();
            updateLocalSummary();
            if (state.componentes.length > 0 || Object.values(f).some(val=>val !== '')) showMessage("Datos restaurados.", 'info');
        },80);
    } catch(e){ console.warn('Restore autosave failed', e); }
}

/* Validaciones */
function animateAndFocusInvalid(el) {
    if (!el) return;
    el.setAttribute('aria-invalid','true');
    el.classList.add('input-invalid','input-shake');
    el.scrollIntoView({behavior:'smooth',block:'center'});
    setTimeout(()=>{ el.classList.remove('input-shake'); },600);
    try{ el.focus({preventScroll:true}); }catch(e){ el.focus(); }
}
function clearFieldError(el){ if(!el) return; const s = el.parentElement.querySelector('.field-error'); if(s) s.remove(); }
function showFieldError(el,msg){ if(!el) return; let s = el.parentElement.querySelector('.field-error'); if(!s){ s=document.createElement('span'); s.className='field-error'; el.parentElement.appendChild(s);} s.textContent=msg; }

/* EnvÃ­o a Google Sheets */
async function sendDataToSheet(data, options={showOverlay:true,clearOnSuccess:true,attemptNetworkOnly:false}) {
    const payload = {
        kitCode: data.kitCode,
        tecnico: data.tecnico,
        estado: data.estado,
        sede: data.sede,
        dependencia: data.dependencia,
        anexoKit: data.anexoKit,
        tipoCargo: data.tipoCargo,
        responsableTipo: data.responsableTipo,
        responsableNombre: data.responsableNombre,
        usuarioFinal: data.usuarioFinal,
        components: data.components
    };
    try {
        if (options.showOverlay) showOverlay(true,'Enviando...');
        if (options.showOverlay) await simulateProgress(0.15);
        const response = await fetch(SHEET_URL, {
            method:'POST',
            mode:'no-cors',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(payload)
        });
        if (options.showOverlay) await simulateProgress(1.0);
        if (options.showOverlay) showOverlay(false);
        if (options.clearOnSuccess) localStorage.removeItem(LS_KEY);
        if (!options.attemptNetworkOnly) { showMessage("Â¡EnvÃ­o exitoso!",'success'); resetForm(); }
    } catch(error) {
        if (options.showOverlay) showOverlay(false);
        console.error('Error al enviar:', error);
        if (!options.attemptNetworkOnly) { pushPendingSubmission(payload); showMessage("Error de envÃ­o. Datos guardados localmente.",'error'); }
        else { showMessage(`Reintento fallÃ³ para ${data.kitCode}.`,'error'); throw error; }
    }
}
function simulateProgress(target=1.0){ return new Promise(resolve=>{ if(dom.progressBar) dom.progressBar.style.width = `${target*100}%`; setTimeout(resolve,350); }); }

/* Campos dinÃ¡micos */
function mostrarCampos() {
    const tipo = (dom.tipoCargo.value||'').toString().trim().toUpperCase();
    const contenedor = dom.camposDinamicos;
    contenedor.innerHTML = "";
    if (!tipo) { updateLocalSummary(); return; }
    const bloqueResponsable = `
       <div class="form-group full-width-field" id="responsable-block">
           <label for="nombreResponsable">RESPONSABLE DEL CARGO:*</label>
           <div class="responsable-group">
               <select id="tipoResponsable" required>
                   <option value="728">728</option>
                   <option value="276">276</option>
                   <option value="CAS">CAS</option>
               </select>
               <input type="text" id="nombreResponsable" placeholder="Nombre Asignado" required />
           </div>
       </div>`;
    const bloqueUsuarioFinal = `
       <div class="form-group full-width-field" id="usuario-final-block">
           <label for="usuarioFinalName">USUARIO FINAL DEL EQUIPO (TITULAR):*</label>
           <input type="text" id="usuarioFinalName" placeholder="Llenar nombre del usuario final" required />
       </div>`;
    const isUserFinalRequired = (tipo === "VOL" || tipo === "TER" || tipo === "SEC");
    let htmlContent = bloqueResponsable;
    if (isUserFinalRequired) { htmlContent += bloqueUsuarioFinal; contenedor.classList.add('stacked'); }
    else contenedor.classList.remove('stacked');
    contenedor.innerHTML = htmlContent;
    const nombreRespInput = document.getElementById('nombreResponsable');
    const usuarioFinalInput = document.getElementById('usuarioFinalName');
    const tipoRespSelect = document.getElementById('tipoResponsable');
    if (nombreRespInput) nombreRespInput.addEventListener('input',()=>{ updateLocalSummary(); autosave(); });
    if (usuarioFinalInput) usuarioFinalInput.addEventListener('input',()=>{ updateLocalSummary(); autosave(); });
    if (tipoRespSelect) tipoRespSelect.addEventListener('change',()=>{ updateLocalSummary(); autosave(); });
    updateLocalSummary();
}

/* Resumen y lista */
function updateLocalSummary() {
    const usuarioFinalNameInput = document.getElementById('usuarioFinalName');
    const nombreResponsableInput = document.getElementById('nombreResponsable');
    let titularName = "PENDIENTE";
    if (usuarioFinalNameInput && usuarioFinalNameInput.value) titularName = usuarioFinalNameInput.value.toUpperCase().trim();
    else if (nombreResponsableInput && nombreResponsableInput.value) titularName = nombreResponsableInput.value.toUpperCase().trim();
    const componentesResumenLista = document.getElementById('componentesResumenLista');
    if (state.componentes.length > 0) {
        dom.resumenKit.style.display = "block";
        dom.kitFinal.textContent = `${dom.codigoKitUsuario.value} - ${titularName}`;
        componentesResumenLista.innerHTML = state.componentes.map(c=>{
            let parts = [`<strong>[${c.tipo.toUpperCase()}]</strong>`];
            if (c.codigoKitComp) parts.push(`${c.codigoKitComp}:`);
            let details=[];
            if (c.ip) details.push(`IP: ${c.ip}`);
            if (c.marca && c.modelo) details.push(`${c.marca} ${c.modelo}`);
            if (c.patrimonial) details.push(`Patr: ${c.patrimonial}`);
            if (details.length>0) parts.push(`<span style="font-style:italic;">${details.join(' | ')}</span>`);
            if (c.marguesi) parts.push(`(CB: ${c.marguesi})`);
            if (c.nro_serie) parts.push(`(SN: ${c.nro_serie})`);
            return `<li style="margin-bottom:6px;border-bottom:1px dotted #ccc;padding-bottom:4px;font-size:0.9em;">${parts.join(' ')}</li>`;
        }).join('');
    } else {
        dom.resumenKit.style.display = "none";
        componentesResumenLista.innerHTML = '';
    }
}
function refreshComponentList() {
    dom.listaComponentes.innerHTML = '';
    for (const c of state.componentes) {
        const li = document.createElement('li');
        let parts=[`[${c.tipo.toUpperCase()}]`];
        if (c.codigoKitComp) parts.push(`${c.codigoKitComp}`);
        if (c.ip) parts.push(`IP: ${c.ip}`);
        if (c.patrimonial) parts.push(`Patrimonial: ${c.patrimonial}`);
        if (c.marca) parts.push(`Marca: ${c.marca}`);
        if (c.modelo) parts.push(`Modelo: ${c.modelo}`);
        if (c.marguesi) parts.push(`Marguesi: ${c.marguesi}`);
        if (c.nro_serie) parts.push(`NÂ° Serie: ${c.nro_serie}`);
        li.textContent = parts.join(' - ');
        dom.listaComponentes.appendChild(li);
    }
}

/* Mostrar formulario */
function mostrarFormulario(validateBefore=true) {
    const tipoSeleccionado = dom.tipoComponente.value;
    if (validateBefore && tipoSeleccionado && !validateInfoFields()) {
        dom.tipoComponente.value = ""; dom.formularioComponente.style.display = "none"; return;
    }
    actualizarCamposPorTipo(tipoSeleccionado);
    const tipo = dom.tipoComponente.value;
    dom.formularioComponente.style.display = tipo ? "block" : "none";
    if (tipo) {
        const codigoKitUsuario = dom.codigoKitUsuario.value;
        if (!codigoKitUsuario || codigoKitUsuario === "Cargando...") {
            showMessage("Esperando asignaciÃ³n de CÃ³digo de KIT...", "info");
            dom.tipoComponente.value = ""; dom.formularioComponente.style.display = "none"; return;
        }
        const isKitCompRequired = ['cpu','monitor','teclado','laptop','docking','ups','camaraweb','mouse'].includes(tipo);
        dom.codigoKitCompContainer.style.display = isKitCompRequired ? "block" : "none";
        if (isKitCompRequired) { if (!state.contador[tipo]) state.contador[tipo]=1; const currentCount = state.contador[tipo]; dom.codigoKitComp.value = `${codigoKitUsuario}-${tipo.toUpperCase()}-${String(currentCount).padStart(4,'0')}`; }
        else dom.codigoKitComp.value = "";
        if (validateBefore) {
            document.getElementById('ip') && (document.getElementById('ip').value="");
            document.getElementById('patrimonial') && (document.getElementById('patrimonial').value="");
            dom.marguesi.value=""; dom.nro_serie.value=""; dom.marca.value=""; dom.modelo.value="";
        }
        stopScanning(false);
    }
}

/* Agregar componente */
function agregarComponente() {
    if (!validateInfoFields()) return;
    const tipo = dom.tipoComponente.value;
    if (!tipo) { showMessage("Seleccione un Tipo de Componente.",'error'); animateAndFocusInvalid(dom.tipoComponente); return; }
    if (!validateComponentFields(tipo)) return;
    const marguesi = (dom.marguesi.value||'').toUpperCase().trim();
    const nroSerie = (dom.nro_serie.value||'').toUpperCase().trim();
    const marca = (dom.marca.value||'').toUpperCase().trim();
    const modelo = (dom.modelo||'').toUpperCase().trim();
    const ip = (document.getElementById('ip')||{}).value||'';
    const patrimonial = (document.getElementById('patrimonial')||{}).value||'';
    let codigoKitComp = "SIN-KIT";
    const isKitCompRequired = ['cpu','monitor','teclado','laptop','docking','ups','camaraweb','mouse'].includes(tipo);
    if (isKitCompRequired) codigoKitComp = dom.codigoKitComp.value;
    state.componentes.push({ tipo, marguesi, nro_serie:nroSerie, marca, modelo, codigoKitComp: isKitCompRequired?codigoKitComp:null, ip: ip||null, patrimonial: patrimonial||null });
    if (isKitCompRequired) state.contador[tipo] = (state.contador[tipo]||1)+1;
    refreshComponentList(); updateLocalSummary(); showMessage(`Componente ${tipo.toUpperCase()} agregado.`,'success'); beep(0.06,880,0.06);
    autosave(); dom.tipoComponente.value=""; mostrarFormulario(false);
}

/* Reset y obtener nuevo KIT */
function resetForm(){ const allInputs=document.querySelectorAll('input[type="text"]:not([readonly]), select'); allInputs.forEach(input=>{ if(input.id==='tipoResponsable') return; if(input.tagName==='SELECT') input.value=''; else input.value=''; input.removeAttribute('aria-invalid'); input.classList.remove('input-invalid'); clearFieldError(input); }); dom.anexoKit&&(dom.anexoKit.value=''); dom.listaComponentes.innerHTML=''; state.componentes=[]; const defaultContador={ cpu:1, monitor:1, teclado:1, laptop:1, docking:1, ups:1, camaraweb:1, mouse:1 }; state.contador={...defaultContador}; dom.tipoCargo.value=''; mostrarCampos(); dom.resumenKit.style.display='none'; dom.formularioComponente.style.display='none'; localStorage.removeItem(LS_KEY); dom.codigoKitUsuario.value='Cargando...'; getNewKitCode(); }

function enviarFormulario(){ if(!validateInfoFields()) return; if(state.componentes.length===0){ showMessage("Debe agregar al menos un componente.",'error'); animateAndFocusInvalid(dom.tipoComponente); return; } const tipoResponsableInput=document.getElementById('tipoResponsable'); const nombreResponsableInput=document.getElementById('nombreResponsable'); const usuarioFinalNameInput=document.getElementById('usuarioFinalName'); const nombreResponsable = nombreResponsableInput?nombreResponsableInput.value.toUpperCase().trim():""; const nombreUsuarioFinal = (usuarioFinalNameInput&&usuarioFinalNameInput.value)?usuarioFinalNameInput.value.toUpperCase().trim():nombreResponsable; const submissionData = { kitCode: dom.codigoKitUsuario.value, estado: dom.estado.options[dom.estado.selectedIndex].value, tecnico: dom.tecnicoResponsable.options[dom.tecnicoResponsable.selectedIndex].text, sede: dom.sede.options[dom.sede.selectedIndex].text, dependencia: dom.dependencia.options[dom.dependencia.selectedIndex].text, anexoKit: (dom.anexoKit||{}).value||'', tipoCargo: dom.tipoCargo.options[dom.tipoCargo.selectedIndex].text, responsableTipo: tipoResponsableInput?tipoResponsableInput.value:"N/A", responsableNombre: nombreResponsable, usuarioFinal: nombreUsuarioFinal, components: state.componentes }; sendDataToSheet(submissionData,{showOverlay:true,clearOnSuccess:true,attemptNetworkOnly:false}); }

async function getNewKitCode() {
    let finalKitCode = "KIT-0001";
    try {
        dom.codigoKitUsuario.value = "Cargando...";
        showMessage("Obteniendo ID de KIT...", 'info');
        const response = await fetch(SHEET_URL);
        if (!response.ok) {
            let errorBody = "Error de red";
            try { errorBody = await response.text(); } catch(_) {}
            throw new Error(`Error ${response.status}: ${response.statusText} - ${errorBody}`);
        }
        const data = await response.json();
        if (data.result === "success" && data.nextKitCode) { finalKitCode = data.nextKitCode; showMessage(`ID de KIT asignado: ${finalKitCode}`,'success'); }
        else throw new Error(data.message || "Respuesta invÃ¡lida del script");
    } catch(error) {
        console.error('Error al obtener el nuevo KIT ID:', error);
        if (error instanceof TypeError && error.message.includes('Failed to fetch')) showMessage("Error de conexiÃ³n (CORS?). Usando ID por defecto.", 'error');
        else showMessage(`Error al obtener ID: ${error.message}. Usando ID por defecto.`, 'error');
        finalKitCode = "KIT-0001";
    } finally {
        dom.codigoKitUsuario.value = finalKitCode;
        restoreAutosave();
    }
}

function actualizarCamposPorTipo(tipo){ const ipGroup=document.getElementById('ip-group'); const marguesiGroup=document.getElementById('marguesi-group'); const patrimonialGroup=document.getElementById('patrimonial-group'); const marcaGroup=document.getElementById('marca-group'); const modeloGroup=document.getElementById('modelo-group'); const nroSerieGroup=document.getElementById('nro_serie-group'); const isCPUOrLaptop=['cpu','laptop'].includes(tipo); const isPeriferico=['fotocopiadora','impresora','escaner','ups','camaraweb'].includes(tipo); const mostrarIP = isCPUOrLaptop || isPeriferico; ipGroup.style.display = mostrarIP ? 'block' : 'none'; const mostrarCamposEstandar = tipo !== ''; marguesiGroup.style.display = mostrarCamposEstandar ? 'block' : 'none'; patrimonialGroup.style.display = mostrarCamposEstandar ? 'block' : 'none'; marcaGroup.style.display = mostrarCamposEstandar ? 'block' : 'none'; modeloGroup.style.display = mostrarCamposEstandar ? 'block' : 'none'; nroSerieGroup.style.display = mostrarCamposEstandar ? 'block' : 'none'; [document.getElementById('ip'), dom.marguesi, document.getElementById('patrimonial'), dom.marca, dom.modelo, dom.nro_serie].filter(Boolean).forEach(el=>{ el.removeAttribute('aria-invalid'); el.classList.remove('input-invalid'); clearFieldError(el); if (el.id==='marguesi' && el.parentElement.classList.contains('input-with-button')) el.parentElement.classList.remove('input-invalid'); });
}

/* ============================
   QUAGGAJS - BLOQUE PRO INTEGRADO
   ============================ */

            // ***************************************************************
            // * IMPLEMENTACIÃ“N DE QUAGGAJS (CÃMARA Y ESCÃNER) - VERSIÃ“N PRO *
            // * Reemplaza el bloque anterior entre los comentarios de inicio/fin *
            // ***************************************************************

            // Config y estado extra para lectura corporativa
            let _pro_lastCodes = []; // buffer de Ãºltimos cÃ³digos detectados
            const PRO_MAX_BUFFER = 7; // Ãºltimos frames a considerar
            const PRO_REQUIRED_REPETITIONS = 3; // repeticiones iguales necesarias
            const PRO_ERROR_THRESHOLD = 45; // suma de errores aceptable (ajustable)
            const PRO_MIN_LENGTH = 12;
            const PRO_CODE_REGEX = /^[A-Z0-9]{12}$/i; // alfanumÃ©rico 12

            // Intenta aplicar constraints "pro" sobre el track activo (HDR / exposure / focus)
            async function applyProCameraConstraints() {
                try {
                    const track = Quagga.CameraAccess.getActiveTrack();
                    if (!track) return;
                    const capabilities = track.getCapabilities ? track.getCapabilities() : {};
                    const constraints = { advanced: [] };

                    // Intentar exposureMode / whiteBalance / focusMode si el dispositivo lo soporta
                    if (capabilities.exposureMode && capabilities.exposureMode.length) {
                        // Algunos navegadores soportan exposureMode: 'continuous'
                        constraints.advanced.push({ exposureMode: 'continuous' });
                    }
                    if (capabilities.whiteBalanceMode && capabilities.whiteBalanceMode.length) {
                        constraints.advanced.push({ whiteBalanceMode: 'continuous' });
                    }
                    if (capabilities.focusMode && capabilities.focusMode.length) {
                        constraints.advanced.push({ focusMode: 'continuous' });
                    }

                    // Intentar forzar un rango de resoluciÃ³n alto (HDR-friendly)
                    constraints.width = { ideal: 1920 };
                    constraints.height = { ideal: 1080 };

                    // Aplicar si tenemos algo que aplicar
                    if (constraints.advanced.length || constraints.width || constraints.height) {
                        await track.applyConstraints(constraints).catch(e => {
                            // No es crÃ­tico; solo informar
                            console.warn('applyProCameraConstraints not fully supported:', e);
                        });
                    }
                } catch (e) {
                    console.warn('applyProCameraConstraints failed', e);
                }
            }

            // Refocus periÃ³dico (algunos Android requieren re-enfoque)
            let _pro_refocusInterval = null;
            function startPeriodicRefocus() {
                try {
                    if (_pro_refocusInterval) clearInterval(_pro_refocusInterval);
                    const track = Quagga.CameraAccess.getActiveTrack();
                    if (!track) return;
                    const capabilities = track.getCapabilities ? track.getCapabilities() : {};
                    // Si el dispositivo soporta focusDistance o focusMode, intentaremos reaplicar constraints
                    if ((capabilities.focusMode && capabilities.focusMode.length) || capabilities.focusDistance) {
                        _pro_refocusInterval = setInterval(async () => {
                            try {
                                await applyProCameraConstraints();
                            } catch(e){}
                        }, 1500); // cada 1.5s
                    }
                } catch(e){ console.warn('startPeriodicRefocus', e); }
            }
            function stopPeriodicRefocus() {
                if (_pro_refocusInterval) {
                    clearInterval(_pro_refocusInterval);
                    _pro_refocusInterval = null;
                }
            }

            // Util: normalizar cÃ³digo (trim, quitar espacios y caracteres no alfanum)
            function normalizeCode(raw) {
                if (!raw) return '';
                return raw.toString().trim().replace(/[^A-Z0-9]/ig, '').toUpperCase();
            }

            // Comprueba si el cÃ³digo cumple formato corporativo (12 alfanum)
            function isValidCorporateCode(code) {
                return PRO_CODE_REGEX.test(code) && code.length === PRO_MIN_LENGTH;
            }

            // ConfiguraciÃ³n avanzada para facing
            function quaggaConfigForFacing(facingMode) {
                return {
                    inputStream: {
                        type: "LiveStream",
                        target: dom.videoContainer,
                        constraints: {
                            width: { ideal: 1920 },
                            height: { ideal: 1080 },
                            facingMode: facingMode,
                            aspectRatio: { min: 1, max: 2 },
                            // advanced: [{ torch: true }, { exposureMode: 'continuous' }] // aplicado despuÃ©s si es posible
                        },
                    },
                    locator: {
                        patchSize: "large",     // mejor para cÃ³digos borrosos
                        halfSample: false,      // mantener calidad total
                    },
                    decoder: {
                        // SOLO Code128: reduce falsos positivos en Android
                        readers: [
                            "code_128_reader"
                        ],
                        debug: {
                            drawBoundingBox: true,
                            showFrequency: false,
                            drawScanline: true,
                            showPattern: false
                        },
                        multiple: false
                    },
                    locate: true,
                    numOfWorkers: Math.max(2, (navigator.hardwareConcurrency || 4) - 1),
                    frequency: 20 // frames per second processing target (bajar si CPU baja)
                };
            }

            // Callback robusto que requiere repeticiones iguales y chequeos de confianza
            function onQuaggaDetected(data) {
                try {
                    if (!data || !data.codeResult || !data.codeResult.code) return;

                    const now = Date.now();
                    // Cooldown para prevenir floods
                    if (now - state.lastScanTimestamp < 350) {
                        // permitir cierta frecuencia (mÃ¡s agresivo porque validamos repeticiones)
                    }

                    // Sumar errores reportados por decodedCodes (si existen)
                    let errorSum = 0;
                    if (Array.isArray(data.codeResult.decodedCodes)) {
                        errorSum = data.codeResult.decodedCodes.reduce((acc, d) => acc + (d && d.error ? d.error : 0), 0);
                    }

                    // Tomar y normalizar el cÃ³digo
                    const raw = data.codeResult.code || '';
                    const norm = normalizeCode(raw);

                    // Rechazar si no tiene la longitud esperada (evita muchos falsos)
                    if (norm.length !== PRO_MIN_LENGTH) {
                        console.log('Rechazado por longitud:', norm);
                        return;
                    }

                    // Rechazar si no cumple el patrÃ³n alfanumÃ©rico (corporate)
                    if (!isValidCorporateCode(norm)) {
                        console.log('Rechazado por patrÃ³n:', norm);
                        return;
                    }

                    // Rechazar si el error interno es demasiado alto
                    if (errorSum > PRO_ERROR_THRESHOLD) {
                        console.log('Rechazado por baja confianza interna (errorSum):', errorSum, norm);
                        return;
                    }

                    // Buffer de Ãºltimos cÃ³digos
                    _pro_lastCodes.push(norm);
                    if (_pro_lastCodes.length > PRO_MAX_BUFFER) _pro_lastCodes.shift();

                    // Contar repeticiones del cÃ³digo actual en buffer
                    const reps = _pro_lastCodes.filter(x => x === norm).length;

                    console.log(`Detected candidate: ${norm} (reps: ${reps}, err:${errorSum})`);

                    // Requiere N repeticiones iguales para aceptar (robustez SAP-level)
                    if (reps >= PRO_REQUIRED_REPETITIONS) {
                        // Ã‰xito: limpiar buffer y reportar
                        _pro_lastCodes = [];

                        state.lastScanTimestamp = Date.now();
                        beep(0.08, 900, 0.08);
                        flashFrame();

                        if (state.activeInput) {
                            state.activeInput.value = norm;
                            state.activeInput.dispatchEvent(new Event('input', { bubbles: true }));
                        }

                        if (state.activeInput && state.activeInput.parentElement && state.activeInput.parentElement.classList.contains('input-with-button')) {
                            state.activeInput.parentElement.classList.remove('input-invalid');
                        }

                        stopScanning(false);
                        showMessage("CÃ³digo patrimonial escaneado correctamente.", 'success');
                    }
                } catch (e) {
                    console.error('onQuaggaDetected PROC error', e);
                }
            }

            // Procesado visual (mantener)
            function onQuaggaProcessed(result) {
                const drawingCtx = Quagga.canvas && Quagga.canvas.ctx && Quagga.canvas.ctx.overlay;
                const drawingCanvas = Quagga.canvas && Quagga.canvas.dom && Quagga.canvas.dom.overlay;

                if (drawingCtx && drawingCanvas) {
                    drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")||0), parseInt(drawingCanvas.getAttribute("height")||0));

                    if (result) {
                        if (result.boxes) {
                            result.boxes.filter(box => box !== result.box).forEach(box => {
                                Quagga.ImageDebug.drawPath(box, { x: 0, y: 1 }, drawingCtx, { color: "rgba(0,255,0,0.35)", lineWidth: 2 });
                            });
                        }
                        if (result.box) {
                            Quagga.ImageDebug.drawPath(result.box, { x: 0, y: 1 }, drawingCtx, { color: "#00F", lineWidth: 2 });
                        }
                        if (result.codeResult && result.codeResult.code && result.line) {
                            Quagga.ImageDebug.drawPath(result.line, { x: 'x', y: 'y' }, drawingCtx, { color: 'red', lineWidth: 3 });
                        }
                    }
                }
            }

            // Iniciar escaneo (con mejoras pro)
            function startScanning() {
                if (state.scanning) return;

                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showMessage("Tu navegador no soporta el acceso a la cÃ¡mara.", 'error');
                    return;
                }

                state.scanning = true;
                dom.videoContainer.style.display = "block";
                dom.retryBtn.style.display = "none";
                dom.toggleTorchBtn.style.display = 'none';

                const config = quaggaConfigForFacing(state.currentFacingMode);

                Quagga.init(config, async (err) => {
                    if (err) {
                        console.error("Error al iniciar Quagga:", err);
                        showMessage(`Error de cÃ¡mara: ${err.message}`, 'error');
                        stopScanning(true);
                        return;
                    }
                    console.log("Quagga iniciado (PRO).");

                    // Intentar aplicar constraints pro en el track
                    try {
                        await applyProCameraConstraints();
                        startPeriodicRefocus();
                    } catch(e){
                        console.warn('applyProCameraConstraints failed', e);
                    }

                    // Verificar linterna
                    try {
                        const track = Quagga.CameraAccess.getActiveTrack();
                        const capabilities = track && track.getCapabilities ? track.getCapabilities() : {};
                        if (capabilities && capabilities.torch) {
                            state.torchAvailable = true;
                            dom.toggleTorchBtn.style.display = 'inline-block';
                        } else {
                            state.torchAvailable = false;
                        }
                    } catch (e) {
                        state.torchAvailable = false;
                    }

                    Quagga.start();

                    // Registrar listeners pro (reemplazar listeners previos)
                    Quagga.offDetected && Quagga.offDetected(onQuaggaDetected);
                    Quagga.offProcessed && Quagga.offProcessed(onQuaggaProcessed);
                    Quagga.onDetected(onQuaggaDetected);
                    Quagga.onProcessed(onQuaggaProcessed);
                });
            }

            // Detener escaneo (limpieza pro)
            function stopScanning(showRetry = true) {
                if (!state.scanning && !(Quagga.CameraAccess && Quagga.CameraAccess.getActiveTrack && Quagga.CameraAccess.getActiveTrack())) return;

                console.log("Deteniendo escÃ¡ner (PRO)...");
                state.scanning = false;
                try {
                    Quagga.stop();
                } catch(e) { console.warn("Quagga.stop failed", e); }

                try {
                    Quagga.offDetected && Quagga.offDetected(onQuaggaDetected);
                    Quagga.offProcessed && Quagga.offProcessed(onQuaggaProcessed);
                } catch(e){}

                stopPeriodicRefocus();

                dom.videoContainer.style.display = "none";
                dom.retryBtn.style.display = showRetry ? "block" : "none";
                state.lastScanTimestamp = 0;
                _pro_lastCodes = [];
            }

            // Cambiar cÃ¡mara (mantener)
            function switchCamera() {
                if (state.scanning) {
                    stopScanning(false);
                    state.currentFacingMode = (state.currentFacingMode === 'environment') ? 'user' : 'environment';
                    setTimeout(startScanning, 150);
                }
            }

            // Toggle torch (mÃ¡s robusto)
            async function toggleTorch() {
                if (!state.torchAvailable || !state.scanning) return;
                try {
                    const track = Quagga.CameraAccess.getActiveTrack();
                    if (!track) return;
                    const currentConstraints = track.getConstraints();
                    const isTorchOn = !!(currentConstraints.advanced && currentConstraints.advanced.find(c => c.torch)?.torch);
                    await track.applyConstraints({ advanced: [{ torch: !isTorchOn }] });
                } catch (err) {
                    console.error('Error al cambiar la linterna (PRO):', err);
                }
            }

            // ***************************************************************
            // * FIN IMPLEMENTACIÃ“N QUAGGAJS - VERSIÃ“N PRO
            // ***************************************************************

/* ---------------------------
   InicializaciÃ³n y listeners
   ---------------------------*/
function validateInfoFields(){
    const nombreResponsableInput = document.getElementById('nombreResponsable');
    const tipoResponsableInput = document.getElementById('tipoResponsable');
    const anexoKitInput = dom.anexoKit;
    const infoInputs = [dom.tecnicoResponsable, dom.sede, dom.dependencia, dom.tipoCargo, dom.estado].filter(Boolean);
    let firstInvalidElement = null;
    for (const input of infoInputs) {
        const value = (input.value || '').toString().trim();
        if (value === '' || value === 'Seleccione...' || value === '-- Seleccionar --') {
            animateAndFocusInvalid(input);
            if (!firstInvalidElement) firstInvalidElement = input;
        } else {
            input.removeAttribute('aria-invalid'); input.classList.remove('input-invalid'); clearFieldError(input);
        }
    }
    if (anexoKitInput && anexoKitInput.value.trim() && !/^\d{5}$/.test(anexoKitInput.value.trim())) {
        animateAndFocusInvalid(anexoKitInput);
        showFieldError(anexoKitInput, "Anexo debe ser exactamente 5 dÃ­gitos.");
        if (!firstInvalidElement) firstInvalidElement = anexoKitInput;
    } else if (anexoKitInput) { anexoKitInput.removeAttribute('aria-invalid'); anexoKitInput.classList.remove('input-invalid'); clearFieldError(anexoKitInput); }
    let dynamicValid = true;
    if (nombreResponsableInput && !nombreResponsableInput.value.trim()) { animateAndFocusInvalid(nombreResponsableInput); if (!firstInvalidElement) firstInvalidElement = nombreResponsableInput; dynamicValid = false; } else if (nombreResponsableInput) { nombreResponsableInput.removeAttribute('aria-invalid'); nombreResponsableInput.classList.remove('input-invalid'); clearFieldError(nombreResponsableInput); }
    if (tipoResponsableInput && !tipoResponsableInput.value.trim()) { animateAndFocusInvalid(tipoResponsableInput); if (!firstInvalidElement) firstInvalidElement = tipoResponsableInput; dynamicValid = false; } else if (tipoResponsableInput) { tipoResponsableInput.removeAttribute('aria-invalid'); tipoResponsableInput.classList.remove('input-invalid'); clearFieldError(tipoResponsableInput); }
    const tipoCargo = dom.tipoCargo.value;
    const isUserFinalRequired = (tipoCargo === "VOL" || tipoCargo === "TER" || tipoCargo === "SEC");
    if (isUserFinalRequired) {
        const usuarioFinalInput = document.getElementById('usuarioFinalName');
        if (usuarioFinalInput && !usuarioFinalInput.value.trim()) { animateAndFocusInvalid(usuarioFinalInput); if (!firstInvalidElement) firstInvalidElement = usuarioFinalInput; dynamicValid = false; } else if (usuarioFinalInput) { usuarioFinalInput.removeAttribute('aria-invalid'); usuarioFinalInput.classList.remove('input-invalid'); clearFieldError(usuarioFinalInput); }
    }
    const isValid = !firstInvalidElement && dynamicValid;
    if (!isValid) {
        if (!firstInvalidElement || firstInvalidElement.id !== 'anexoKit') showMessage("Por favor, complete campos obligatorios (*).",'error');
    }
    return isValid;
}

function validateComponentFields(tipo) {
    const ip = document.getElementById('ip');
    const marguesi = dom.marguesi;
    const nroSerie = dom.nro_serie;
    const marca = dom.marca;
    const modelo = dom.modelo;
    let isValid = true;
    let firstInvalidElement = null;
    if (!marguesi || !marguesi.value.trim()) { isValid = false; if (!firstInvalidElement) firstInvalidElement = marguesi; }
    if (!marca || !marca.value.trim()) { isValid = false; if (!firstInvalidElement) firstInvalidElement = marca; }
    if (!modelo || !modelo.value.trim()) { isValid = false; if (!firstInvalidElement) firstInvalidElement = modelo; }
    if (!nroSerie || !nroSerie.value.trim()) { isValid = false; if (!firstInvalidElement) firstInvalidElement = nroSerie; }
    [marguesi, marca, modelo, nroSerie].filter(Boolean).forEach(el=>{
        if (!el.value.trim()) { animateAndFocusInvalid(el); if (el.id==='marguesi' && el.parentElement.classList.contains('input-with-button')) el.parentElement.classList.add('input-invalid'); }
        else { el.removeAttribute('aria-invalid'); el.classList.remove('input-invalid'); clearFieldError(el); if (el.id==='marguesi' && el.parentElement.classList.contains('input-with-button')) el.parentElement.classList.remove('input-invalid'); }
    });
    if (ip) { ip.removeAttribute('aria-invalid'); ip.classList.remove('input-invalid'); clearFieldError(ip); }
    if (!isValid) showMessage("Por favor, complete los campos (*) del componente.", 'error');
    return isValid;
}

/* Pending submissions helpers */
function pushPendingSubmission(submission) {
    try {
        const raw = localStorage.getItem(LS_PENDING_SUBMISSIONS);
        const arr = raw ? JSON.parse(raw) : [];
        arr.push({ submission, timestamp: Date.now() });
        localStorage.setItem(LS_PENDING_SUBMISSIONS, JSON.stringify(arr));
    } catch(e){ console.warn('pushPendingSubmission', e); }
}
async function retryPendingSubmissions() {
    try {
        const raw = localStorage.getItem(LS_PENDING_SUBMISSIONS);
        if (!raw) return;
        let arr = JSON.parse(raw);
        if (!arr || !arr.length) return;
        showMessage(`Reintentando ${arr.length} envÃ­os pendientes...`, 'info');
        let successCount = 0; const failedItems = [];
        for (const item of arr) {
            try { await sendDataToSheet(item.submission, { showOverlay:false, clearOnSuccess:false, attemptNetworkOnly:true }); successCount++; }
            catch(e){ console.warn('Pending send failed', e); failedItems.push(item); }
        }
        if (failedItems.length === 0) { localStorage.removeItem(LS_PENDING_SUBMISSIONS); if (successCount>0) showMessage("EnvÃ­os pendientes procesados.", 'success'); else dom.messageBox.style.display='none'; }
        else { localStorage.setItem(LS_PENDING_SUBMISSIONS, JSON.stringify(failedItems)); showMessage(`${failedItems.length} envÃ­os aÃºn pendientes.`,'error'); }
    } catch(e){ console.warn('retryPendingSubmissions', e); }
}

window.addEventListener('online', ()=>{ showMessage('ConexiÃ³n restablecida.','info'); retryPendingSubmissions(); });

/* Init & listeners */
function initApp(){
    dom.tecnicoResponsable = document.getElementById("tecnicoResponsable");
    dom.sede = document.getElementById("sede");
    dom.dependencia = document.getElementById("dependencia");
    dom.estado = document.getElementById("estado");
    dom.anexoKit = document.getElementById("anexoKit");
    getNewKitCode();
    dom.anexoKit.addEventListener('input', ()=>{ autosave(); if (dom.anexoKit.hasAttribute('aria-invalid') && (!dom.anexoKit.value.trim() || /^\d{5}$/.test(dom.anexoKit.value.trim()))) { dom.anexoKit.removeAttribute('aria-invalid'); dom.anexoKit.classList.remove('input-invalid'); clearFieldError(dom.anexoKit); } });
    dom.tecnicoResponsable.addEventListener('change', autosave);
    dom.sede.addEventListener('change', autosave);
    dom.dependencia.addEventListener('change', autosave);
    dom.estado.addEventListener('change', autosave);
    dom.tipoCargo.addEventListener('change', ()=>{ mostrarCampos(); autosave(); });
    document.querySelectorAll('input[type="text"]:not([readonly])').forEach(input=>{ if(input.id!=='ip' && input.id!=='anexoKit'){ input.addEventListener('input', ()=>{ input.value = input.value.toUpperCase(); autosave(); }); } else { input.addEventListener('input', autosave); } });
    document.querySelectorAll(".scan-btn").forEach(btn=>{ const inputId = btn.getAttribute('data-input-id'); const input = document.getElementById(inputId); if (input && inputId === 'marguesi'){ btn.addEventListener('click', (e)=>{ e.preventDefault(); state.activeInput = input; if (state.scanning) stopScanning(true); else { dom.retryBtn.style.display='none'; startScanning(); } }); } else if (input) btn.disabled = true; });
    dom.retryBtn.addEventListener('click',(e)=>{ e.preventDefault(); if (state.activeInput && state.activeInput.id === 'marguesi') startScanning(); });
    dom.switchCameraBtn && dom.switchCameraBtn.addEventListener('click',(e)=>{ e.preventDefault(); switchCamera(); });
    dom.toggleTorchBtn && dom.toggleTorchBtn.addEventListener('click',(e)=>{ e.preventDefault(); toggleTorch(); });
    if (navigator.onLine) retryPendingSubmissions();
    setInterval(autosave, 5000);
}
document.addEventListener('DOMContentLoaded', initApp);

/* Expose some functions to HTML (if needed) */
document.getElementById('add-component').addEventListener('click', agregarComponente);
document.getElementById('send-form').addEventListener('click', enviarFormulario);

/* End of reconstructed script */
</script>
</body>
</html>
