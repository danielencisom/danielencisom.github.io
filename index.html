<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <meta name="theme-color" content="#1976D2" />
    <title>Registro de Equipos de C√≥mputo - Sistema Profesional v2</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Biblioteca ZXing -->
    <script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>
    
    <!-- Biblioteca Tesseract.js para OCR -->
    <script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>
    
    <script>
    // === Mejoras de validaci√≥n y animaci√≥n ===
    
    // Limpiar invalid al corregir campo
    function clearInvalidOnInput(el) {
        if (!el) return;
        const eventType = (el.tagName === 'SELECT') ? 'change' : 'input';
        
        const clearHandler = () => {
            el.removeAttribute('aria-invalid');
            el.classList.remove('input-invalid');
            clearFieldError(el);
            if (el.parentElement && el.parentElement.classList.contains('input-with-button')) {
                 el.parentElement.classList.remove('input-invalid');
            }
            el.removeEventListener(eventType, clearHandler);
        };
        
        el.addEventListener(eventType, clearHandler, { once: true });
    }

    // Animar, centrar y ATACAR el listener de limpieza
    function animateAndFocusInvalid(el) {
        if (!el) return;
        el.setAttribute('aria-invalid', 'true');
        el.classList.add('input-invalid','input-shake');
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => { el.classList.remove('input-shake'); }, 600);
        try { el.focus({ preventScroll: true }); } catch(e){ el.focus(); }
        
        clearInvalidOnInput(el);
    }

    // Mostrar mensaje de error inline
    function showFieldError(el, msg) {
        let sibling = el.parentElement.querySelector('.field-error');
        if (!sibling) {
            sibling = document.createElement('span');
            sibling.className = 'field-error';
            el.parentElement.appendChild(sibling);
        }
        sibling.textContent = msg;
    }
    
    function clearFieldError(el) {
        const sibling = el.parentElement.querySelector('.field-error');
        if (sibling) sibling.remove();
    }

    // === Overlay mejorado ===
    let lastActiveElementBeforeOverlay = null;
    function showOverlay(show = true, subText = '') {
        const ov = document.getElementById('overlay');
        const progressBar = document.getElementById('progress-bar');
        const loaderSub = document.getElementById('loader-sub');
        if (!ov || !progressBar || !loaderSub) return;

        if (show) {
            lastActiveElementBeforeOverlay = document.activeElement;
            ov.classList.add('show');
            ov.setAttribute('aria-hidden', 'false');
            ov.setAttribute('aria-busy', 'true');
            progressBar.style.width = '6%';
            loaderSub.textContent = subText || 'Procesando...';
            document.querySelectorAll('button, input, select').forEach(el => {
                if (!ov.contains(el)) {
                    el.dataset._wasDisabled = el.disabled ? '1' : '0';
                    el.disabled = true;
                }
            });
            document.addEventListener('keydown', escOverlayHandler);
        } else {
            ov.classList.remove('show');
            ov.setAttribute('aria-hidden', 'true');
            ov.setAttribute('aria-busy', 'false');
            progressBar.style.width = '0%';
            document.querySelectorAll('[data-_wasDisabled]').forEach(el => {
                el.disabled = el.dataset._wasDisabled === '1';
                delete el.dataset._wasDisabled;
            });
            document.removeEventListener('keydown', escOverlayHandler);
            try { lastActiveElementBeforeOverlay && lastActiveElementBeforeOverlay.focus(); } catch(e){}
        }
    }

    function escOverlayHandler(e) {
        if (e.key === 'Escape') {
            console.warn('Operaci√≥n en curso, no se puede cancelar.');
        }
    }

    // Feedback visual al detectar correctamente
    function flashFrame() {
        const frame = document.querySelector('.scan-frame');
        if (!frame) return;
        frame.style.borderColor = '#4CAF50';
        frame.style.boxShadow = '0 0 25px #4CAF50';
        setTimeout(() => {
            frame.style.borderColor = 'rgba(0,255,0,0.8)';
            frame.style.boxShadow = '0 0 20px rgba(0,255,0,0.4)';
        }, 600);
    }
    
    // Funci√≥n para vibrar en dispositivos m√≥viles
    function vibrate(pattern = 100) {
        if (navigator.vibrate) {
            navigator.vibrate(pattern);
        }
    }
    
    // Sonido de confirmaci√≥n
    function playScanSound() {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        } catch (e) {
            console.warn('No se pudo reproducir sonido:', e);
        }
    }

    // Procesamiento de imagen para c√≥digos borrosos
    function enhanceImage(canvas) {
        const ctx = canvas.getContext('2d');
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        
        // Aplicar filtro de contraste
        const contrast = 1.5;
        const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
        
        for (let i = 0; i < data.length; i += 4) {
            // Convertir a escala de grises
            const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
            
            // Aplicar contraste
            let newGray = factor * (gray - 128) + 128;
            newGray = Math.max(0, Math.min(255, newGray));
            
            // Aplicar umbral para binarizaci√≥n
            const threshold = 128;
            const binary = newGray > threshold ? 255 : 0;
            
            data[i] = binary;     // R
            data[i + 1] = binary; // G
            data[i + 2] = binary; // B
            // Alpha permanece igual
        }
        
        ctx.putImageData(imageData, 0, 0);
        return canvas;
    }
    </script>

    <style>
        :root{
            --primary-color:#1976D2;
            --secondary-color:#4CAF50;
            --danger-color:#D32F2F;
            --warning-color:#FF9800;
            --info-color:#2196F3;
            --background-light:#f4f6f9;
            --surface-light:#ffffff;
            --text-dark:#333;
            --border-color:#ddd;
            --invalid-color:#f44336;
            --overlay-bg: rgba(0,0,0,0.45);
            --patrimonial-color:#9C27B0;
            --marguesi-color:#2196F3;
            --comercial-color:#FF9800;
            --serial-color:#4CAF50;
            --success-light: #E8F5E9;
            --info-light: #E3F2FD;
            --warning-light: #FFF3E0;
        }
        
        html,body{
            height:100%;
            margin:0;
            padding:0;
            background:var(--background-light);
            font-family:'Roboto',Arial,sans-serif;
            color:var(--text-dark);
            -webkit-overflow-scrolling:touch;
            -webkit-tap-highlight-color: transparent;
        }
        
        .outer{
            display:flex;
            justify-content:center;
            padding:18px;
        }
        
        .container{
            width:100%;
            max-width:980px;
            margin:0 auto;
            max-height:calc(100vh - 36px);
            overflow-y:auto;
            padding-bottom:24px;
        }
        
        h1{
            color:var(--primary-color);
            text-align:center;
            margin-bottom:18px;
            font-weight:700;
            font-size:1.8em;
        }
        
        h2,h3{
            color:var(--primary-color);
            margin-top:18px;
            border-bottom:2px solid var(--primary-color);
            padding-bottom:6px;
            font-weight:500;
        }
        
        .card{
            background:var(--surface-light);
            padding:16px;
            border-radius:8px;
            margin-bottom:18px;
            box-shadow:0 4px 10px rgba(0,0,0,0.06);
            transition: all 0.3s ease;
        }
        
        .card.active-scan {
            box-shadow: 0 0 0 3px var(--primary-color), 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .form-group{
            margin-bottom:12px;
        }
        
        label{
            display:block;
            margin-bottom:6px;
            font-weight:500;
            font-size:0.95em;
        }
        
        .field-hint {
            font-size: 0.8em;
            color: #666;
            font-weight: normal;
            margin-left: 5px;
        }
        
        input[type="text"], select{
            padding:10px 12px;
            border:1px solid var(--border-color);
            border-radius:4px;
            width:100%;
            box-sizing:border-box;
            font-size:1em;
            transition:border-color .25s,box-shadow .25s;
            background: white;
        }
        
        .select-with-icon {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            padding-right: 35px;
        }
        
        input[type="text"]:focus, select:focus{
            border-color:var(--primary-color);
            outline:none;
            box-shadow:0 0 0 3px rgba(25,118,210,0.08);
        }
        
        .input-invalid{
            border-color:var(--invalid-color) !important;
            box-shadow:0 0 0 3px rgba(244,67,54,0.12) !important;
        }
        
        input[readonly]{
            background:#eee;
            color:#555;
            cursor:default;
        }
        
        .input-with-button{
            display:flex;
            align-items:center;
            border:1px solid var(--border-color);
            border-radius:4px;
            overflow:hidden;
            background: white;
        }
        
        .input-with-button input{
            border:none;
            flex-grow:1;
            padding:10px 12px;
            font-size:1em;
            background: transparent;
        }
        
        .scan-btn{
            background-color:var(--primary-color);
            color:white;
            border:none;
            padding:10px 15px;
            cursor:pointer;
            font-size:1.1em;
            line-height:1;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            min-height: 44px;
        }
        
        .scan-btn:hover, .scan-btn:active{
            background-color:#1565C0;
        }
        
        .scan-btn.scanning {
            background-color: var(--danger-color);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .btn-action{
            border:none;
            padding:12px 20px;
            margin-top:12px;
            border-radius:6px;
            cursor:pointer;
            font-size:1em;
            font-weight:500;
            width:100%;
            transition:background-color .2s;
            background-color:var(--secondary-color);
            color:var(--surface-light);
            min-height: 44px;
        }
        
        .btn-action:hover{
            background-color:#388E3C;
        }
        
        .btn-danger{
            background-color:var(--danger-color);
            color:var(--surface-light);
            width:100%;
            padding:10px;
            margin-top:10px;
            border:none;
            border-radius:4px;
            cursor:pointer;
        }
        
        .btn-danger:hover{
            background-color:#C62828;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 8px;
        }
        
        .btn-warning:hover {
            background-color: #F57C00;
        }
        
        #listaComponentes{
            list-style:none;
            padding:0;
            margin:0;
        }
        
        #listaComponentes li{
            background:#e3f2fd;
            margin-bottom:8px;
            padding:10px;
            border-left:5px solid var(--primary-color);
            border-radius:4px;
            font-size:0.95em;
        }
        
        #resumenKit{
            background:#e0f2f1;
            border-left:5px solid var(--secondary-color);
        }
        
        /* Contenedor de video mejorado */
        #video-container{
            margin-top:12px;
            position:relative;
            width:100%;
            height:320px;
            overflow:hidden;
            background:#000;
            border-radius:4px;
            display: none;
        }
        
        #video-container video{
            width:100%;
            height:100%;
            object-fit: cover;
            display:block;
            transform: scaleX(-1); /* Espejo para parecer natural */
        }
        
        /* Controles de c√°mara */
        .video-controls{
            position:absolute;
            right:10px;
            top:10px;
            z-index:20;
            display:flex;
            gap:8px;
            align-items:center;
            background: rgba(0,0,0,0.5);
            padding: 8px;
            border-radius: 8px;
        }
        
        .video-controls button{
            background:rgba(255,255,255,0.9);
            border:none;
            color:#333;
            padding:8px 12px;
            border-radius:6px;
            cursor:pointer;
            font-size:0.9em;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            min-height: 44px;
        }
        
        .video-controls button:hover{
            background:white;
        }
        
        /* Marco de escaneo mejorado */
        .scan-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 65%;
            height: 30%;
            border: 3px solid rgba(0, 255, 0, 0.8);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.4);
            z-index: 10;
            pointer-events: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00ff00, transparent);
            top: 50%;
            animation: scan 2s linear infinite;
            box-shadow: 0 0 10px #00ff00;
        }
        
        @keyframes scan {
            0% { top: 10%; }
            100% { top: 90%; }
        }
        
        .dynamic-fields{
            display:grid;
            grid-template-columns:1fr;
            gap:12px;
            margin-top:4px;
        }
        
        .responsable-group{
            display:flex;
            gap:10px;
        }
        
        .responsable-group select{
            width:30%;
            flex-shrink:0;
        }
        
        .full-width-field{
            grid-column:1 / -1;
        }
        
        #message-box{
            display:none;
            padding:10px;
            border-radius:6px;
            margin-bottom:12px;
            font-weight:500;
        }
        
        .msg-error{
            background:#ffeeee;
            color:var(--danger-color);
            border-left:5px solid var(--danger-color);
        }
        
        .msg-success{
            background:#e8f5e9;
            color:var(--secondary-color);
            border-left:5px solid var(--secondary-color);
        }
        
        .msg-info{
            background:#e3f2fd;
            color:var(--primary-color);
            border-left:5px solid var(--primary-color);
        }
        
        .msg-warning {
            background: #fff3e0;
            color: var(--warning-color);
            border-left: 5px solid var(--warning-color);
        }
        
        @media (min-width:768px){
            .dynamic-fields{
                grid-template-columns:1fr 1fr;
            }
            .dynamic-fields.stacked>.form-group{
                grid-column:1 / -1;
            }
        }
        
        @media (max-width:420px){
            .scan-btn{
                padding:12px 14px;
                font-size:1.15em;
            }
            .btn-action{
                padding:14px;
                font-size:1.05em;
            }
            #video-container {
                height: 280px;
            }
        }

        /* Overlay loader */
        .overlay{
            position:fixed;
            left:0;
            right:0;
            top:0;
            bottom:0;
            background:var(--overlay-bg);
            display:flex;
            align-items:center;
            justify-content:center;
            z-index:9999;
            display:none;
        }
        
        .loader-card{
            width:90%;
            max-width:420px;
            background:#fff;
            padding:18px;
            border-radius:10px;
            box-shadow:0 10px 40px rgba(0,0,0,0.25);
            text-align:center;
        }
        
        .loader-title{
            font-weight:600;
            color:var(--primary-color);
            margin-bottom:12px;
        }
        
        .progress{
            height:10px;
            background:#eee;
            border-radius:999px;
            overflow:hidden;
            margin:12px 0;
        }
        
        .progress-bar{
            height:100%;
            width:0%;
            background:linear-gradient(90deg,var(--primary-color),#63a4ff);
            transition:width 0.45s ease;
        }
        
        .loader-sub{
            text-transform:uppercase;
            font-size:0.85em;
            color:#666;
            margin-top:6px;
        }

        /* === Mejoras de animaci√≥n y validaci√≥n === */
        @keyframes shake {
            0% { transform: translateX(0); }
            20% { transform: translateX(-6px); }
            40% { transform: translateX(6px); }
            60% { transform: translateX(-4px); }
            80% { transform: translateX(4px); }
            100% { transform: translateX(0); }
        }
        
        .input-shake { 
            animation: shake 520ms ease-in-out; 
        }

        .input-invalid {
            border-color: var(--invalid-color) !important;
            box-shadow: 0 0 0 4px rgba(244,67,54,0.12) !important;
        }
        
        .input-with-button.input-invalid {
            border-color: var(--invalid-color) !important;
            box-shadow: 0 0 0 4px rgba(244,67,54,0.12) !important;
        }

        .overlay.show { 
            display:flex; 
            animation: overlayFade .28s ease forwards; 
        }
        
        @keyframes overlayFade {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .progress-bar { 
            transition: width 420ms cubic-bezier(0.2,0.9,0.2,1); 
        }

        .field-error {
            color: var(--invalid-color);
            font-size: 0.85em;
            margin-top: 6px;
            display: block;
            font-weight: 500;
        }
        
        /* Indicador de tipo de c√≥digo */
        .code-type-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 30;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
            color: white;
            background: rgba(0,0,0,0.7);
        }
        
        .code-type-patrimonial {
            background-color: var(--patrimonial-color);
        }
        
        .code-type-marguesi {
            background-color: var(--marguesi-color);
        }
        
        .code-type-comercial {
            background-color: var(--comercial-color);
        }
        
        .code-type-serial {
            background-color: var(--serial-color);
        }
        
        /* Zoom controls */
        #zoom-controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            z-index: 25;
            display: flex;
            align-items: center;
            background: rgba(0,0,0,0.7);
            padding: 8px 12px;
            border-radius: 20px;
            display: none;
        }
        
        #zoom-slider {
            flex-grow: 1;
            margin: 0 10px;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            background: #fff;
            border-radius: 2px;
            outline: none;
        }
        
        #zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }
        
        .zoom-label {
            color: white;
            font-size: 1em;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }
        
        /* Estad√≠sticas de escaneo */
        .scan-stats {
            position: absolute;
            bottom: 50px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            z-index: 20;
        }
        
        /* Panel de informaci√≥n de c√≥digo */
        #code-info {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            background: #f0f8ff;
            border-left: 4px solid var(--info-color);
        }
        
        #code-info strong {
            color: #333;
            font-weight: 600;
        }
        
        #detected-type, #detected-format, #detected-validation {
            color: #1976D2;
            font-weight: 500;
        }
        
        /* Panel de mejora de imagen */
        .image-enhance-panel {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 30;
            display: flex;
            gap: 8px;
        }
        
        .enhance-btn, .capture-btn {
            background: rgba(25, 118, 210, 0.9);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .enhance-btn:hover, .capture-btn:hover {
            background: rgba(25, 118, 210, 1);
        }
        
        /* Estilos espec√≠ficos para dispositivos m√≥viles */
        .device-xiaomi .scan-frame {
            border-width: 2px;
        }
        
        .device-samsung #video-container {
            height: 340px;
        }
        
        .device-honor #video-container {
            height: 300px;
        }
        
        /* Canvas para captura manual */
        #capture-canvas {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        /* Consejos para escaneo */
        .scan-tips {
            background: #FFF3E0;
            border-left: 4px solid #FF9800;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .scan-tips h4 {
            margin: 0 0 5px 0;
            color: #E65100;
        }
        
        .scan-tips ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .scan-tips li {
            margin-bottom: 3px;
        }
        
        /* Optimizaci√≥n de rendimiento */
        .performance-mode {
            animation: none !important;
            transition: none !important;
        }
        
        /* Indicador de esc√°ner activo */
        .scanner-active-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
            z-index: 30;
        }
        
        /* NUEVOS ESTILOS PARA LAS MEJORAS */
        
        /* Estado de campos */
        .campos-status {
            background: var(--info-light);
            border-left: 4px solid var(--info-color);
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }
        
        .status-icon {
            font-size: 1.2em;
        }
        
        .status-text {
            flex-grow: 1;
        }
        
        /* Feedback de selecci√≥n de componente */
        .component-selection-feedback {
            background: var(--success-light);
            border-left: 4px solid var(--secondary-color);
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .feedback-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .feedback-icon {
            font-size: 1.5em;
        }
        
        .feedback-text {
            font-weight: 500;
            font-size: 1.1em;
        }
        
        .feedback-instructions {
            background: rgba(255, 255, 255, 0.7);
            padding: 8px;
            border-radius: 4px;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .scan-badge {
            background: var(--primary-color);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        /* Indicador de estrategia de escaneo */
        .scan-strategy-indicator {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: bold;
            z-index: 30;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .strategy-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
        }
        
        .strategy-dot.active {
            background: #FFEB3B;
            box-shadow: 0 0 8px #FFEB3B;
        }
        
        /* Panel de estrategias de escaneo */
        .scan-strategies-panel {
            position: absolute;
            bottom: 60px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px;
            border-radius: 8px;
            z-index: 25;
            max-width: 200px;
        }
        
        .strategy-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px;
            font-size: 0.8em;
        }
        
        .strategy-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .strategy-status.active {
            background: #4CAF50;
        }
        
        .strategy-status.inactive {
            background: #757575;
        }
        
        .strategy-status.failed {
            background: #f44336;
        }
    </style>
</head>

<body>
    <div class="outer">
        <div class="container" role="main">
            <h1>REGISTRO DE EQUIPOS DE C√ìMPUTO</h1>

            <div id="message-box" class="card" aria-live="polite"></div>

            <div class="card">
                <h2>üìã Informaci√≥n General del KIT y Ubicaci√≥n</h2>
                <div class="form-group">
                    <label for="codigoKitUsuario">C√≥digo del KIT:</label>
                    <input type="text" id="codigoKitUsuario" value="KIT-0001" readonly />
                </div>
                <!-- NUEVO CAMPO: ESTADO -->
                <div class="form-group">
                    <label for="estado">üìå Estado del Equipo:*</label>
                    <select id="estado" required class="select-with-icon">
                        <option value="">Seleccione...</option>
                        <option value="Operativo">Operativo</option>
                        <option value="De Baja">De Baja</option>
                        <option value="Pendiente">Pendiente</option>
                    </select>
                </div>
                <!-- FIN NUEVO CAMPO -->
                <div class="form-group">
                    <label for="tecnicoResponsable">üë®‚Äçüíº T√©cnico Responsable:*</label>
                    <select id="tecnicoResponsable" required class="select-with-icon">
                        <option value="">Seleccione...</option>
                        <option value="CH">CARLOS HUACHO</option>
                        <option value="JI">JOSUE IBA√ëEZ</option>
                        <option value="DE">DANIEL ENCISO</option>
                        <option value="OO">ODAR OLAYA</option>
                        <option value="JL">JOSE LUYO</option>
                        <option value="SC">SANTIAGO CARPIO</option>
                        <option value="DC">DAVID COTERA</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sede">üè¢ Sede:*</label>
                    <select id="sede" required class="select-with-icon">
                        <option value="">Seleccione...</option>
                        <option value="SS12">SEDE SAENZ PE√ëA 120</option>
                        <option value="SS17">SEDE SAENZ PE√ëA 175-177-181</option>
                        <option value="SS15">SEDE SAENZ PE√ëA 155-157</option>
                        <option value="SS18">SEDE KING 1</option>
                        <option value="SS19">SEDE KING 2</option>
                        <option value="SS20">SEDE GRAU</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="dependencia">üìÅ Dependencia:*</label>
                    <select id="dependencia" required class="select-with-icon">
                        <option value="">-- Seleccionar --</option>
    
    <!-- 8FPPC -->
    <optgroup label="8FPPC">
        <option value="8FPPC DEL 1 DESPACHO">8FPPC DEL 1 DESPACHO</option>
        <option value="8FPPC DEL 2 DESPACHO">8FPPC DEL 2 DESPACHO</option>
        <option value="8FPPC DEL 3 DESPACHO">8FPPC DEL 3 DESPACHO</option>
        <option value="8FPPC DEL 4 DESPACHO">8FPPC DEL 4 DESPACHO</option>
    </optgroup>
    
    <!-- 9FPPC -->
    <optgroup label="9FPPC">
        <option value="9FPPC DEL 1 DESPACHO">9FPPC DEL 1 DESPACHO</option>
        <option value="9FPPC DEL 2 DESPACHO">9FPPC DEL 2 DESPACHO</option>
        <option value="9FPPC DEL 3 DESPACHO">9FPPC DEL 3 DESPACHO</option>
        <option value="9FPPC DEL 4 DESPACHO">9FPPC DEL 4 DESPACHO</option>
    </optgroup>
    
    <!-- PREVENCION -->
    <option value="PREVENCION">PREVENCION</option>
    
    <!-- LAVADO -->
    <optgroup label="LAVADO">
        <option value="LAVADO 1 DESPACHO">LAVADO 1 DESPACHO</option>
        <option value="LAVADO 1 2 DESPACHO">LAVADO 1 2 DESPACHO</option>
        <option value="LAVADO 3 DESPACHO">LAVADO 3 DESPACHO</option>
    </optgroup>
    
    <!-- ADUANAS -->
    <optgroup label="ADUANAS">
        <option value="ADUANAS 1 DESPACHO">ADUANAS 1 DESPACHO</option>
        <option value="ADUANAS 2 DESPACHO">ADUANAS 2 DESPACHO</option>
        <option value="ADUANAS 3 DESPACHO">ADUANAS 3 DESPACHO</option>
    </optgroup>
    
    <!-- Otras √°reas -->
    <option value="ADMINISTRACION">ADMINISTRACION</option>
    <option value="ODCI">ODCI</option>
    <option value="Peritos">Peritos</option>
                    </select>
                </div>
                
                <!-- CAMPO ANEXO -->
                <div class="form-group" id="anexo-group">
                    <label for="anexoKit">üìû N¬∞ de Anexo (Tel√©fono - Solo 5 n√∫meros):</label>
                    <input type="text" id="anexoKit" placeholder="Escriba el N¬∞ de Anexo (e.g., 12345)" pattern="\d{5}" maxlength="5" />
                </div>
            </div>

            <!-- SECCI√ìN MEJORADA: Informaci√≥n de Usuario Responsable de KIT -->
            <div class="card">
                <h2>üë§ Informaci√≥n de Usuario Responsable del KIT</h2>
                <div class="form-group">
                    <label for="tipoCargo">üìã TIPO DE CARGO:* <span class="field-hint">(Define los campos requeridos)</span></label>
                    <select id="tipoCargo" onchange="window.app.mostrarCampos()" required class="select-with-icon">
                        <option value="">Seleccione...</option>
                        <option value="ASD">ASISTENTE ADMINISTRATIVO</option>
                        <option value="AFF">ASISTENTE FUNCION FISCAL</option>
                        <option value="AUD">AUXILIAR ADMINISTRATIVO</option>
                        <option value="COOR">COORDINADOR</option>
                        <option value="EA">ESPECIALISTA ADMINISTRATIVO</option>
                        <option value="FAF">FISCAL ADJUNTO FISCAL</option>
                        <option value="OAD">OPERADOR ADMINISTRATIVO</option>
                        <option value="PRO">PROGRAMADOR</option>
                        <option value="SEC">SECIGRISTA</option>
                        <option value="TAD">TECNICO ADMINISTRATIVO</option>
                        <option value="TER">TERCERO</option>
                        <option value="VOL">VOLUNTARIO</option>
                    </select>
                </div>
                
                <!-- Indicador de estado de campos -->
                <div id="campos-status" class="campos-status" style="display:none;">
                    <span class="status-icon">‚è≥</span>
                    <span class="status-text">Configurando campos seg√∫n el cargo seleccionado...</span>
                </div>
                
                <div id="camposDinamicos" class="dynamic-fields">
                    <!-- Los campos din√°micos se insertar√°n aqu√≠ -->
                </div>
            </div>

            <!-- SECCI√ìN MEJORADA: Registro de Componentes -->
            <div class="card">
                <h2>üñ•Ô∏è Registro de Componentes</h2>
                
                <div class="form-group">
                    <label for="tipoComponente">üîß Seleccionar Componente:* <span class="field-hint">(Los campos se adaptar√°n al tipo seleccionado)</span></label>
                    <select id="tipoComponente" onchange="window.app.mostrarFormulario()" class="select-with-icon">
                        <option value="">-- Seleccionar --</option>
                        <option value="cpu">üíª CPU</option>
                        <option value="laptop">üíª Laptop</option>
                        <option value="monitor">üñ•Ô∏è Monitor</option>
                        <option value="teclado">‚å®Ô∏è Teclado</option>
                        <option value="docking">üîó Docking</option>
                        <optgroup label="üñ®Ô∏è Perif√©ricos">
                            <option value="fotocopiadora">üì† Fotocopiadora</option>
                            <option value="impresora">üñ®Ô∏è Impresora Multifuncional</option>
                            <option value="escaner">üìÑ Esc√°ner</option>
                            <option value="ups">üîã UPS</option>
                            <option value="camaraweb">üìπ C√°mara Web</option>
                        </optgroup>
                    </select>
                </div>
                
                <!-- Feedback de selecci√≥n de componente -->
                <div class="component-selection-feedback" id="component-feedback" style="display:none;">
                    <div class="feedback-header">
                        <span class="feedback-icon">‚úÖ</span>
                        <span class="feedback-text">Componente seleccionado: <strong id="selected-component-name"></strong></span>
                    </div>
                    <div class="feedback-instructions">
                        <p>Complete los campos obligatorios (*) para este componente.</p>
                        <p>Use el bot√≥n <span class="scan-badge">üì∑</span> para escanear c√≥digos de barras autom√°ticamente.</p>
                    </div>
                </div>

                <div class="card" id="formularioComponente" style="display:none;padding:12px;background:#f9f9f9;box-shadow:none;">
                    <!-- Indicador de estrategias de escaneo -->
                    <div class="scan-strategy-indicator" id="scan-strategy-indicator" style="display:none;">
                        <span>Estrategia:</span>
                        <div class="strategy-dot" id="strategy-dot-1"></div>
                        <div class="strategy-dot" id="strategy-dot-2"></div>
                        <div class="strategy-dot" id="strategy-dot-3"></div>
                        <div class="strategy-dot" id="strategy-dot-4"></div>
                    </div>
                    
                    <div class="form-group" id="codigoKitCompContainer">
                        <label for="codigoKitComp">üè∑Ô∏è C√≥digo del KIT del Componente:</label>
                        <input type="text" id="codigoKitComp" readonly />
                    </div>

                    <div class="form-group" id="ip-group" style="display:none;">
                        <label for="ip">üåê Direcci√≥n IP:</label>
                        <input type="text" id="ip" placeholder="Direcci√≥n IP (e.g., 192.168.1.100)" 
                               pattern="^(\d{1,3}\.){3}\d{1,3}$" />
                    </div>

                    <div class="form-group" id="marguesi-group" style="display:none;">
                        <label>üè∑Ô∏è COD. MARGUESI:*</label>
                        <div class="input-with-button">
                            <input id="marguesi" type="text" class="scanable" placeholder="Escanea o escribe el c√≥digo de barras" autocomplete="off" />
                            <button class="scan-btn" data-input-id="marguesi" type="button" id="scan-btn-marguesi">üì∑</button>
                        </div>
                    </div>
                    
                    <div class="form-group" id="nro_serie-group" style="display:none;">
                        <label for="nro_serie">üî¢ N¬∞ SERIE:*</label>
                        <input type="text" id="nro_serie" placeholder="Escribe el N√∫mero de Serie" />
                    </div>

                    <!-- CONTENEDOR DE VIDEO PARA ESC√ÅNER -->
                    <div id="video-container">
                        <video id="video"></video>
                        <canvas id="capture-canvas"></canvas>
                        <div class="scan-frame">
                            <div class="scan-line"></div>
                        </div>
                        
                        <!-- Panel de estrategias de escaneo -->
                        <div class="scan-strategies-panel" id="scan-strategies-panel" style="display:none;">
                            <div class="strategy-item">
                                <div class="strategy-status" id="strategy-1-status"></div>
                                <span>ZXing Directo</span>
                            </div>
                            <div class="strategy-item">
                                <div class="strategy-status" id="strategy-2-status"></div>
                                <span>ZXing + Imagen Mejorada</span>
                            </div>
                            <div class="strategy-item">
                                <div class="strategy-status" id="strategy-3-status"></div>
                                <span>OCR Tesseract</span>
                            </div>
                            <div class="strategy-item">
                                <div class="strategy-status" id="strategy-4-status"></div>
                                <span>Captura Manual</span>
                            </div>
                        </div>
                        
                        <div class="scanner-active-indicator" id="scanner-active-indicator" style="display:none;">
                            SISTEMA DE ESCANEO MULTI-ESTRATEGIA ACTIVO
                        </div>
                        <div class="video-controls">
                            <button id="switch-camera" title="Cambiar c√°mara">‚Üª</button>
                            <button id="toggle-torch" title="Linterna">üî¶</button>
                            <button id="close-scanner" title="Cerrar esc√°ner">‚úï</button>
                        </div>
                        <div class="image-enhance-panel">
                            <button id="enhance-image" class="enhance-btn" title="Mejorar imagen para c√≥digos borrosos">‚ú® Mejorar</button>
                            <button id="manual-capture" class="capture-btn" title="Capturar imagen manualmente">üì∏ Capturar</button>
                        </div>
                        <div id="zoom-controls">
                            <span class="zoom-label">üîç</span>
                            <input type="range" id="zoom-slider" min="1" max="5" step="0.1" value="1">
                            <span class="zoom-label">üîç</span>
                        </div>
                        <div class="scan-stats" id="scan-stats">Escaneando...</div>
                    </div>
                    
                    <div class="scan-tips" id="scan-tips" style="display:none;">
                        <h4>üí° Consejos para escanear:</h4>
                        <ul>
                            <li>Mant√©n el c√≥digo estable dentro del marco verde</li>
                            <li>Usa buena iluminaci√≥n</li>
                            <li>Para c√≥digos borrosos, usa "‚ú® Mejorar"</li>
                            <li>Si falla el auto-escaneo, usa "üì∏ Capturar"</li>
                            <li>El sistema intentar√° 4 estrategias diferentes autom√°ticamente</li>
                        </ul>
                    </div>
                    
                    <div id="code-info" style="display:none; margin-top:10px; padding:10px; border-radius:4px; background:#f0f8ff;">
                        <strong>üéØ Tipo detectado:</strong> <span id="detected-type">--</span><br>
                        <strong>üìä Formato:</strong> <span id="detected-format">--</span><br>
                        <strong>‚úÖ Validaci√≥n:</strong> <span id="detected-validation">--</span><br>
                        <strong>üîÑ Estrategia usada:</strong> <span id="detected-strategy">--</span>
                    </div>
                    
                    <button id="retry-btn" class="btn-danger" style="display:none;" type="button">üîÑ Volver a intentar escaneo</button>
                    
                    <div class="form-group" id="patrimonial-group" style="display:none;">
                        <label for="patrimonial">üèõÔ∏è COD. PATRIMONIAL (Opcional):</label>
                        <input type="text" id="patrimonial" placeholder="C√≥digo Patrimonial" />
                    </div>

                    <div class="form-group" id="marca-group" style="display:none;">
                        <label for="marca">üè∑Ô∏è Marca:*</label>
                        <input type="text" id="marca" placeholder="Marca del componente" />
                    </div>

                    <div class="form-group" id="modelo-group" style="display:none;">
                        <label for="modelo">üìê Modelo:*</label>
                        <input type="text" id="modelo" placeholder="Modelo del componente" />
                    </div>
                    
                    <button class="btn-action" onclick="window.app.agregarComponente()" type="button">‚ûï Agregar Componente</button>
                </div>
            </div>

            <div class="card">
                <h3>üìã Componentes a√±adidos al KIT</h3>
                <ul id="listaComponentes"></ul>
            </div>

            <div class="card" id="resumenKit" style="display:none;">
                 <h3>üìä Resumen del KIT</h3>
                 <p><strong>üè∑Ô∏è KIT y Titular:</strong> <span id="kitFinal"></span></p>
                 <h4>üñ•Ô∏è Componentes Registrados:</h4>
                 <ul id="componentesResumenLista" style="list-style-type:none;padding-left:0;"></ul>
            </div>

            <button class="btn-action" onclick="window.app.enviarFormulario()" style="margin-bottom:26px;" type="button">üöÄ Enviar KIT a Registro</button>
        </div>
    </div>

    <!-- Overlay/Loader global -->
    <div id="overlay" class="overlay" aria-hidden="true">
        <div class="loader-card" role="status" aria-live="polite">
             <div class="loader-title">Enviando datos...</div>
             <div class="progress"><div id="progress-bar" class="progress-bar"></div></div>
             <div id="loader-sub" class="loader-sub">Conectando con servidor...</div>
       </div>
    </div>

    <script>
        /*******************************************************************
         * App: Registro de Equipos - Versi√≥n PROFESIONAL CON SISTEMA MULTI-ESTRATEGIA
         * Sistema completo con 4 estrategias de escaneo:
         * 1. ZXing con procesamiento b√°sico
         * 2. ZXing con imagen mejorada
         * 3. OCR Tesseract para c√≥digos de texto
         * 4. Captura manual con procesamiento avanzado
         * Optimizado para Android (Xiaomi, Honor, Samsung)
         *******************************************************************/

        window.app = (function () {
            // URL de Google Apps Script 
            const SHEET_URL = "https://script.google.com/macros/s/AKfycbzAK7pa6QFlDboMxXjMYjsBqIl03NWlt67LDeEoFEN1aZvjGRZYpjCGHplrKSqY1Mxb/exec";

            // Estado interno MEJORADO
            const state = {
                contador: { cpu: 1, monitor: 1, teclado: 1, laptop: 1, docking: 1, ups: 1, camaraweb: 1 }, 
                componentes: [],
                scanning: false,
                activeInput: null,
                currentFacingMode: 'environment',
                torchAvailable: false,
                zoomAvailable: false,
                lastScanTimestamp: 0,
                deviceInfo: null,
                codeReader: null,
                currentStream: null,
                scanCount: 0,
                validCodes: 0,
                isCameraInitialized: false,
                isManualMode: false,
                currentCanvas: null,
                scanAttempts: 0,
                maxScanAttempts: 50,
                imageProcessingEnabled: false,
                currentStrategy: 0,
                strategies: [
                    { name: 'ZXing Directo', active: false, used: false, success: false },
                    { name: 'ZXing + Imagen Mejorada', active: false, used: false, success: false },
                    { name: 'OCR Tesseract', active: false, used: false, success: false },
                    { name: 'Captura Manual', active: false, used: false, success: false }
                ]
            };

            // ================================
            // NUEVO: Sistema OCR de respaldo
            // ================================
            const OCRSystem = {
                isInitialized: false,
                tesseractWorker: null,
                
                async init() {
                    if (typeof Tesseract === 'undefined') {
                        console.warn('Tesseract.js no est√° disponible para OCR');
                        return false;
                    }
                    
                    try {
                        this.tesseractWorker = await Tesseract.createWorker('eng', 1, {
                            logger: m => console.log('OCR:', m),
                            errorHandler: err => console.error('OCR Error:', err)
                        });
                        
                        await this.tesseractWorker.setParameters({
                            tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-',
                            preserve_interword_spaces: '1'
                        });
                        
                        this.isInitialized = true;
                        console.log('OCR System inicializado');
                        return true;
                    } catch (error) {
                        console.error('Error al inicializar OCR:', error);
                        return false;
                    }
                },
                
                async recognizeFromCanvas(canvas) {
                    if (!this.isInitialized || !this.tesseractWorker) {
                        throw new Error('OCR no inicializado');
                    }
                    
                    try {
                        const { data: { text } } = await this.tesseractWorker.recognize(canvas);
                        return text.trim();
                    } catch (error) {
                        console.error('Error en reconocimiento OCR:', error);
                        throw error;
                    }
                },
                
                async destroy() {
                    if (this.tesseractWorker) {
                        await this.tesseractWorker.terminate();
                        this.tesseractWorker = null;
                    }
                    this.isInitialized = false;
                }
            };

            // Validaci√≥n de c√≥digos patrimoniales MEJORADA
            const PatrimonialValidator = {
                patterns: {
                    // Formatos patrimoniales institucionales
                    PATRIMONIAL: [
                        {
                            regex: /^PAT-([A-Z]{2,3})-(\d{4})-(\d{6})$/,
                            description: 'Patrimonio Institucional',
                            example: 'PAT-IT-2023-000001',
                            colorClass: 'code-type-patrimonial'
                        },
                        {
                            regex: /^INV-([A-Z]{2})-(\d{4})-(\d{5})$/,
                            description: 'Inventario General',
                            example: 'INV-AL-2023-00123',
                            colorClass: 'code-type-patrimonial'
                        },
                        {
                            regex: /^ACT-([A-Z]{3})-(\d{6})$/,
                            description: 'Activo Fijo',
                            example: 'ACT-COM-123456',
                            colorClass: 'code-type-patrimonial'
                        }
                    ],
                    
                    // C√≥digos Marguesi/Asset
                    MARGUESI: [
                        {
                            regex: /^([A-Z]{2,4})(\d{6,8})$/,
                            description: 'C√≥digo Marguesi',
                            example: 'IT2023001',
                            colorClass: 'code-type-marguesi'
                        },
                        {
                            regex: /^ASSET-(\d{6})$/,
                            description: 'Asset Tag',
                            example: 'ASSET-123456',
                            colorClass: 'code-type-marguesi'
                        },
                        {
                            regex: /^SAP-(\d{8})$/,
                            description: 'C√≥digo SAP',
                            example: 'SAP-12345678',
                            colorClass: 'code-type-marguesi'
                        }
                    ],
                    
                    // Seriales de fabricante
                    SERIAL: [
                        {
                            regex: /^[A-Z0-9]{10,20}$/,
                            description: 'N√∫mero de Serie',
                            example: 'CND123456789',
                            colorClass: 'code-type-serial'
                        },
                        {
                            regex: /^SN-([A-Z0-9]{8,15})$/,
                            description: 'Serial Number',
                            example: 'SN-ABCD123456',
                            colorClass: 'code-type-serial'
                        }
                    ],
                    
                    // C√≥digos comerciales
                    COMERCIAL: [
                        {
                            regex: /^(\d{12,13})$/,
                            description: 'EAN-13 / UPC',
                            example: '7501031311309',
                            colorClass: 'code-type-comercial'
                        },
                        {
                            regex: /^([0-9A-Z]{6,20})$/,
                            description: 'CODE-128',
                            example: 'ABC123456789',
                            colorClass: 'code-type-comercial'
                        },
                        {
                            regex: /^(\d{8})$/,
                            description: 'EAN-8',
                            example: '12345678',
                            colorClass: 'code-type-comercial'
                        }
                    ]
                },
                
                validateCode: function(code) {
                    const cleanCode = (code || '').toString().trim().toUpperCase();
                    
                    // Probar todos los patrones
                    for (const [tipo, patrones] of Object.entries(this.patterns)) {
                        for (const patron of patrones) {
                            const match = cleanCode.match(patron.regex);
                            if (match) {
                                return {
                                    isValid: true,
                                    tipo: tipo,
                                    descripcion: patron.description,
                                    codigo: cleanCode,
                                    ejemplo: patron.example,
                                    colorClass: patron.colorClass,
                                    sugerencias: this.getSuggestions(cleanCode),
                                    matchGroups: match.slice(1)
                                };
                            }
                        }
                    }
                    
                    // Si no coincide con ning√∫n patr√≥n, pero parece v√°lido
                    if (this.isLikelyValid(cleanCode)) {
                        return {
                            isValid: true,
                            tipo: 'DESCONOCIDO',
                            descripcion: 'Formato no identificado',
                            codigo: cleanCode,
                            colorClass: 'code-type-marguesi',
                            sugerencias: this.getSuggestions(cleanCode)
                        };
                    }
                    
                    // Si no es v√°lido
                    return {
                        isValid: false,
                        tipo: 'INVALIDO',
                        codigo: cleanCode,
                        error: 'Formato no reconocido'
                    };
                },
                
                getSuggestions: function(code) {
                    const suggestions = [];
                    const cleanCode = code.replace(/[^A-Z0-9]/g, '');
                    
                    // Sugerencias basadas en patrones comunes
                    if (cleanCode.length >= 6) {
                        const year = new Date().getFullYear();
                        suggestions.push(`PAT-IT-${year}-${cleanCode.slice(-6)}`);
                        
                        if (cleanCode.match(/^[A-Z]{2,4}/)) {
                            const prefix = cleanCode.match(/^[A-Z]{2,4}/)[0];
                            suggestions.push(`${prefix}${year}${cleanCode.slice(-4)}`);
                        }
                        
                        suggestions.push(`INV-${cleanCode.slice(0,2)}-${year}-${cleanCode.slice(-5)}`);
                    }
                    
                    return suggestions;
                },
                
                isLikelyValid: function(code) {
                    const cleanCode = (code || '').toString().trim();
                    // M√≠nimo 6 caracteres alfanum√©ricos o con guiones
                    return cleanCode.length >= 6 && /^[A-Z0-9\-]+$/.test(cleanCode);
                }
            };

            // Optimizador de dispositivo MEJORADO
            const DeviceOptimizer = {
                detectDevice: function() {
                    const ua = navigator.userAgent.toLowerCase();
                    const info = {
                        isAndroid: /android/.test(ua),
                        isXiaomi: /miui|xiaomi|redmi|poco/.test(ua),
                        isHonor: /honor|huawei/.test(ua),
                        isSamsung: /samsung|sm-/.test(ua),
                        isChrome: /chrome/.test(ua),
                        isFirefox: /firefox/.test(ua),
                        model: this.extractModel(ua),
                        osVersion: this.extractAndroidVersion(ua),
                        brand: this.getBrand(ua),
                        capabilities: this.detectCapabilities()
                    };
                    
                    // Agregar clase al body para CSS espec√≠fico
                    const body = document.body;
                    if (info.isXiaomi) body.classList.add('device-xiaomi');
                    if (info.isHonor) body.classList.add('device-honor');
                    if (info.isSamsung) body.classList.add('device-samsung');
                    
                    console.log('Dispositivo detectado:', info);
                    return info;
                },
                
                extractModel: function(ua) {
                    const matches = ua.match(/\(.*?;\s*([^;]+)\s*;.*?\)/);
                    return matches ? matches[1] : 'Desconocido';
                },
                
                extractAndroidVersion: function(ua) {
                    const matches = ua.match(/android\s+([\d.]+)/);
                    return matches ? matches[1] : 'Desconocido';
                },
                
                getBrand: function(ua) {
                    if (/xiaomi|redmi|poco/.test(ua)) return 'xiaomi';
                    if (/honor|huawei/.test(ua)) return 'honor';
                    if (/samsung/.test(ua)) return 'samsung';
                    return 'other';
                },
                
                detectCapabilities: function() {
                    const caps = {
                        hasTorch: false,
                        hasZoom: false,
                        maxZoom: 1,
                        hasFocus: false
                    };
                    
                    // Estas capacidades se detectar√°n cuando se acceda a la c√°mara
                    return caps;
                },
                
                getOptimalCameraSettings: function() {
                    const settings = {
                        video: {
                            facingMode: state.currentFacingMode,
                            width: { min: 640, ideal: 1280, max: 1920 },
                            height: { min: 480, ideal: 720, max: 1080 }
                        }
                    };
                    
                    // Ajustes espec√≠ficos por marca
                    if (state.deviceInfo.isXiaomi) {
                        settings.video.frameRate = { ideal: 30, max: 60 };
                        settings.video.focusMode = ['continuous', 'single-shot'];
                    }
                    
                    if (state.deviceInfo.isHonor) {
                        settings.video.width = { ideal: 1280, max: 1920 };
                        settings.video.height = { ideal: 720, max: 1080 };
                        settings.video.frameRate = { ideal: 25 };
                    }
                    
                    if (state.deviceInfo.isSamsung) {
                        settings.video.frameRate = { ideal: 60 };
                    }
                    
                    return settings;
                }
            };

            // DOM refs MEJORADO
            const dom = {
                messageBox: document.getElementById('message-box'),
                tipoCargo: document.getElementById('tipoCargo'),
                camposDinamicos: document.getElementById('camposDinamicos'),
                camposStatus: document.getElementById('campos-status'),
                tipoComponente: document.getElementById("tipoComponente"),
                componentFeedback: document.getElementById("component-feedback"),
                selectedComponentName: document.getElementById("selected-component-name"),
                formularioComponente: document.getElementById("formularioComponente"),
                codigoKitUsuario: document.getElementById("codigoKitUsuario"),
                codigoKitCompContainer: document.getElementById("codigoKitCompContainer"),
                codigoKitComp: document.getElementById("codigoKitComp"),
                marguesi: document.getElementById("marguesi"), 
                nro_serie: document.getElementById("nro_serie"), 
                marca: document.getElementById("marca"), 
                modelo: document.getElementById("modelo"), 
                listaComponentes: document.getElementById("listaComponentes"),
                resumenKit: document.getElementById("resumenKit"),
                kitFinal: document.getElementById("kitFinal"),
                videoContainer: document.getElementById('video-container'),
                videoElement: document.getElementById('video'),
                captureCanvas: document.getElementById('capture-canvas'),
                retryBtn: document.getElementById('retry-btn'),
                scanBtnMarguesi: document.getElementById('scan-btn-marguesi'),
                tecnicoResponsable: null,
                sede: null,
                dependencia: null,
                estado: null, 
                anexoKit: null,
                overlay: document.getElementById('overlay'),
                progressBar: document.getElementById('progress-bar'),
                loaderSub: document.getElementById('loader-sub'),
                switchCameraBtn: document.getElementById('switch-camera'),
                toggleTorchBtn: document.getElementById('toggle-torch'),
                closeScannerBtn: document.getElementById('close-scanner'),
                enhanceImageBtn: document.getElementById('enhance-image'),
                manualCaptureBtn: document.getElementById('manual-capture'),
                zoomControls: document.getElementById('zoom-controls'),
                zoomSlider: document.getElementById('zoom-slider'),
                scanStats: document.getElementById('scan-stats'),
                scannerActiveIndicator: document.getElementById('scanner-active-indicator'),
                scanTips: document.getElementById('scan-tips'),
                codeInfo: document.getElementById('code-info'),
                detectedType: document.getElementById('detected-type'),
                detectedFormat: document.getElementById('detected-format'),
                detectedValidation: document.getElementById('detected-validation'),
                detectedStrategy: document.getElementById('detected-strategy'),
                scanStrategyIndicator: document.getElementById('scan-strategy-indicator'),
                scanStrategiesPanel: document.getElementById('scan-strategies-panel'),
                strategyStatus1: document.getElementById('strategy-1-status'),
                strategyStatus2: document.getElementById('strategy-2-status'),
                strategyStatus3: document.getElementById('strategy-3-status'),
                strategyStatus4: document.getElementById('strategy-4-status'),
                strategyDot1: document.getElementById('strategy-dot-1'),
                strategyDot2: document.getElementById('strategy-dot-2'),
                strategyDot3: document.getElementById('strategy-dot-3'),
                strategyDot4: document.getElementById('strategy-dot-4')
            };

            /**********************
             * UTIL - Feedback MEJORADO
             **********************/
            function showMessage(message, type = 'error') { 
                dom.messageBox.textContent = message;
                dom.messageBox.className = 'card';
                dom.messageBox.classList.add(`msg-${type}`);
                dom.messageBox.style.display = 'block';
                
                // Scroll suave al mensaje
                dom.messageBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
                if (type === 'success') {
                    setTimeout(() => { 
                        dom.messageBox.style.display = 'none'; 
                    }, 3000);
                } else if (type === 'info') {
                    setTimeout(() => { 
                        if (dom.messageBox.textContent === message) {
                            dom.messageBox.style.display = 'none'; 
                        }
                    }, 5000);
                } else {
                    setTimeout(() => { 
                        if (dom.messageBox.textContent === message) {
                            dom.messageBox.style.display = 'none'; 
                        }
                    }, 6000);
                }
            }

            /**********************
             * AUTOSAVE (localStorage) OPTIMIZADO
             **********************/
            const LS_KEY = 'registro_equipos_autosave_v4';
            const LS_PENDING_SUBMISSIONS = 'registro_equipos_pending_submissions_v4';

            function autosave() {
                 try {
                     const data = getFormDataForSave();
                     if (Object.keys(data.form).length > 0 || data.componentes.length > 0) {
                         localStorage.setItem(LS_KEY, JSON.stringify(data));
                     }
                 } catch (e) { 
                     console.warn('Autosave failed', e); 
                 }
            }

            function getFormDataForSave() {
                const nombreResponsableInput = document.getElementById('nombreResponsable');
                const tipoResponsableInput = document.getElementById('tipoResponsable');
                const usuarioFinalNameInput = document.getElementById('usuarioFinalName');
                const ipInput = document.getElementById('ip');
                const patrimonialInput = document.getElementById('patrimonial');

                return {
                    form: {
                        codigoKitUsuario: dom.codigoKitUsuario.value,
                        estado: dom.estado ? dom.estado.value : '',
                        tecnicoResponsable: dom.tecnicoResponsable ? dom.tecnicoResponsable.value : '',
                        sede: dom.sede ? dom.sede.value : '',
                        dependencia: dom.dependencia ? dom.dependencia.value : '',
                        anexoKit: dom.anexoKit ? dom.anexoKit.value : '',
                        tipoCargo: dom.tipoCargo.value,
                        nombreResponsable: (nombreResponsableInput || {}).value || '',
                        tipoResponsable: (tipoResponsableInput || {}).value || '',
                        usuarioFinalName: (usuarioFinalNameInput || {}).value || '',
                        ip: (ipInput || {}).value || '',
                        patrimonial: (patrimonialInput || {}).value || '',
                        marca: dom.marca ? dom.marca.value : '',
                        modelo: dom.modelo ? dom.modelo.value : '',
                        marguesi: dom.marguesi ? dom.marguesi.value : '',
                        nro_serie: dom.nro_serie ? dom.nro_serie.value : '',
                        codigoKitComp: dom.codigoKitComp ? dom.codigoKitComp.value : '',
                        tipoComponente: dom.tipoComponente ? dom.tipoComponente.value : ''
                    },
                    componentes: state.componentes,
                    contador: state.contador,
                    timestamp: Date.now()
                };
            }

            function restoreAutosave() {
                 try {
                     const raw = localStorage.getItem(LS_KEY);
                     if (!raw) return;
                     const payload = JSON.parse(raw);
                     if (!payload) return;

                     const f = payload.form || {};
                     
                     // Restaurar valores b√°sicos
                     if (f.estado && dom.estado) dom.estado.value = f.estado;
                     if (f.tecnicoResponsable && dom.tecnicoResponsable) dom.tecnicoResponsable.value = f.tecnicoResponsable;
                     if (f.sede && dom.sede) dom.sede.value = f.sede;
                     if (f.dependencia && dom.dependencia) dom.dependencia.value = f.dependencia;
                     if (f.anexoKit && dom.anexoKit) dom.anexoKit.value = f.anexoKit;
                     if (f.tipoCargo) dom.tipoCargo.value = f.tipoCargo;

                     if (f.tipoCargo) mostrarCampos();

                     // Restaurar campos din√°micos despu√©s de un breve delay
                     setTimeout(() => {
                         if (f.nombreResponsable) {
                             const el = document.getElementById('nombreResponsable');
                             if (el) el.value = f.nombreResponsable;
                         }
                         if (f.tipoResponsable) {
                             const el = document.getElementById('tipoResponsable');
                             if (el) el.value = f.tipoResponsable;
                         }
                         if (f.usuarioFinalName) {
                            const el = document.getElementById('usuarioFinalName');
                            if (el) el.value = f.usuarioFinalName;
                         }
                         
                         // Restaurar formulario de componente si existe
                         if (f.tipoComponente) {
                             dom.tipoComponente.value = f.tipoComponente;
                             mostrarFormulario(false);
                             
                             // Restaurar campos del componente
                             setTimeout(() => {
                                 if (f.ip) {
                                     const el = document.getElementById('ip');
                                     if (el) el.value = f.ip;
                                 }
                                 if (f.patrimonial) {
                                     const el = document.getElementById('patrimonial');
                                     if (el) el.value = f.patrimonial;
                                 }
                                 if (f.marca) {
                                     const el = document.getElementById('marca');
                                     if (el) el.value = f.marca;
                                 }
                                 if (f.modelo) {
                                     const el = document.getElementById('modelo');
                                     if (el) el.value = f.modelo;
                                 }
                                 if (f.marguesi) {
                                     const el = document.getElementById('marguesi');
                                     if (el) el.value = f.marguesi;
                                 }
                                 if (f.nro_serie) {
                                     const el = document.getElementById('nro_serie');
                                     if (el) el.value = f.nro_serie;
                                 }
                                 if (f.codigoKitComp) {
                                     const el = document.getElementById('codigoKitComp');
                                     if (el) el.value = f.codigoKitComp;
                                 }
                             }, 100);
                         }
                         
                         // Restaurar componentes y contador
                         state.componentes = payload.componentes || [];
                         const defaultContador = { cpu: 1, monitor: 1, teclado: 1, laptop: 1, docking: 1, ups: 1, camaraweb: 1 };
                         state.contador = { ...defaultContador, ...(payload.contador || {}) };

                         refreshComponentList();
                         updateLocalSummary();

                         if (state.componentes.length > 0 || Object.values(f).some(val => val && val !== '')) {
                             showMessage("Datos restaurados desde la √∫ltima sesi√≥n.", 'info');
                         }
                     }, 100);

                 } catch (e) { 
                     console.warn('Restore autosave failed', e); 
                     // Limpiar datos corruptos
                     localStorage.removeItem(LS_KEY);
                 }
            }

            function pushPendingSubmission(submission) { 
                try {
                    const raw = localStorage.getItem(LS_PENDING_SUBMISSIONS);
                    const arr = raw ? JSON.parse(raw) : [];
                    arr.push({ 
                        submission, 
                        timestamp: Date.now(),
                        attemptCount: 0 
                    });
                    localStorage.setItem(LS_PENDING_SUBMISSIONS, JSON.stringify(arr));
                } catch (e) { console.warn('pushPendingSubmission', e); }
            }

            async function retryPendingSubmissions() { 
                 try {
                     const raw = localStorage.getItem(LS_PENDING_SUBMISSIONS);
                     if (!raw) return;
                     let arr = JSON.parse(raw);
                     if (!arr || !arr.length) return;

                     showMessage(`Reintentando ${arr.length} env√≠os pendientes...`, 'info');

                     const failedItems = [];
                     const now = Date.now();
                     const MAX_ATTEMPTS = 3;

                     for (const item of arr) {
                         try {
                             // No reintentar demasiadas veces
                             if (item.attemptCount >= MAX_ATTEMPTS) {
                                 failedItems.push(item);
                                 continue;
                             }
                             
                             item.attemptCount = (item.attemptCount || 0) + 1;
                             
                             await sendDataToSheet(item.submission, { 
                                 showOverlay: false, 
                                 clearOnSuccess: false, 
                                 attemptNetworkOnly: true 
                             });
                             
                             // √âxito, no agregar a failedItems
                         } catch (e) {
                             console.warn('Pending send failed', e);
                             failedItems.push(item);
                         }
                     }
                     
                     if (failedItems.length === 0) {
                         localStorage.removeItem(LS_PENDING_SUBMISSIONS);
                         showMessage("Todos los env√≠os pendientes procesados.", 'success');
                     } else {
                         localStorage.setItem(LS_PENDING_SUBMISSIONS, JSON.stringify(failedItems));
                         showMessage(`${failedItems.length} env√≠os a√∫n pendientes.`, 'warning');
                     }
                 } catch (e) { 
                     console.warn('retryPendingSubmissions', e); 
                 }
            }

            /**********************
             * Validaciones MEJORADAS
             **********************/
            function validateInfoFields() {
                const nombreResponsableInput = document.getElementById('nombreResponsable');
                const tipoResponsableInput = document.getElementById('tipoResponsable');
                const anexoKitInput = dom.anexoKit;
                const infoInputs = [dom.tecnicoResponsable, dom.sede, dom.dependencia, dom.tipoCargo, dom.estado].filter(Boolean);
                let firstInvalidElement = null;
                let isValid = true;

                // Validar campos obligatorios
                for (const input of infoInputs) {
                     const value = (input.value || '').toString().trim();
                     if (value === '' || value === 'Seleccione...' || value === '-- Seleccionar --') {
                         if (!firstInvalidElement) firstInvalidElement = input;
                         animateAndFocusInvalid(input);
                         showFieldError(input, "Este campo es obligatorio");
                         isValid = false;
                     } else {
                         input.removeAttribute('aria-invalid');
                         input.classList.remove('input-invalid');
                         clearFieldError(input);
                     }
                }

                // Validar anexo (si se ingresa)
                 if (anexoKitInput && anexoKitInput.value.trim()) {
                     const anexoValue = anexoKitInput.value.trim();
                     if (!/^\d{5}$/.test(anexoValue)) {
                         if (!firstInvalidElement) firstInvalidElement = anexoKitInput;
                         animateAndFocusInvalid(anexoKitInput);
                         showFieldError(anexoKitInput, "El anexo debe tener exactamente 5 d√≠gitos");
                         isValid = false;
                     } else {
                         anexoKitInput.removeAttribute('aria-invalid');
                         anexoKitInput.classList.remove('input-invalid');
                         clearFieldError(anexoKitInput); 
                     }
                 } else if (anexoKitInput) {
                     anexoKitInput.removeAttribute('aria-invalid');
                     anexoKitInput.classList.remove('input-invalid');
                     clearFieldError(anexoKitInput); 
                 }
                 
                // Validar campos din√°micos
                if (nombreResponsableInput) {
                    if (!nombreResponsableInput.value.trim()) { 
                        if (!firstInvalidElement) firstInvalidElement = nombreResponsableInput;
                        animateAndFocusInvalid(nombreResponsableInput);
                        showFieldError(nombreResponsableInput, "Nombre del responsable es obligatorio");
                        isValid = false;
                    } else {
                        nombreResponsableInput.removeAttribute('aria-invalid');
                        nombreResponsableInput.classList.remove('input-invalid');
                        clearFieldError(nombreResponsableInput);
                    }
                }

                if (tipoResponsableInput) {
                    if (!tipoResponsableInput.value.trim()) { 
                        if (!firstInvalidElement) firstInvalidElement = tipoResponsableInput;
                        animateAndFocusInvalid(tipoResponsableInput);
                        showFieldError(tipoResponsableInput, "Tipo de responsable es obligatorio");
                        isValid = false;
                    } else {
                        tipoResponsableInput.removeAttribute('aria-invalid');
                        tipoResponsableInput.classList.remove('input-invalid');
                        clearFieldError(tipoResponsableInput);
                    }
                }

                // Validar usuario final si es requerido
                const tipoCargo = dom.tipoCargo.value;
                const isUserFinalRequired = (tipoCargo === "VOL" || tipoCargo === "TER" || tipoCargo === "SEC");
                if (isUserFinalRequired) { 
                    const usuarioFinalInput = document.getElementById('usuarioFinalName');
                    if (usuarioFinalInput) {
                        if (!usuarioFinalInput.value.trim()) {
                            if (!firstInvalidElement) firstInvalidElement = usuarioFinalInput;
                            animateAndFocusInvalid(usuarioFinalInput);
                            showFieldError(usuarioFinalInput, "Usuario final es obligatorio para este cargo");
                            isValid = false;
                        } else {
                            usuarioFinalInput.removeAttribute('aria-invalid');
                            usuarioFinalInput.classList.remove('input-invalid');
                            clearFieldError(usuarioFinalInput);
                        }
                    }
                }

                if (!isValid) {
                    showMessage("Por favor, complete todos los campos obligatorios (*).", 'error');
                }
                return isValid;
            }
            
            function validateComponentFields(tipo) {
                 const ip = document.getElementById('ip');
                 const marguesi = dom.marguesi;
                 const nroSerie = dom.nro_serie;
                 const marca = dom.marca;
                 const modelo = dom.modelo;

                 let isValid = true;
                 let firstInvalidElement = null;

                 // Validar IP si es requerida y se ingres√≥
                 if (ip && ip.style.display !== 'none') {
                     if (ip.value.trim()) {
                         const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
                         if (!ipPattern.test(ip.value.trim())) {
                             if (!firstInvalidElement) firstInvalidElement = ip;
                             animateAndFocusInvalid(ip);
                             showFieldError(ip, "Formato de IP inv√°lido (ej: 192.168.1.100)");
                             isValid = false;
                         }
                     }
                 }

                 // Validar campos obligatorios
                 if (!marguesi || !marguesi.value.trim()) {
                     isValid = false; 
                     if (!firstInvalidElement) firstInvalidElement = marguesi;
                 }
                 if (!marca || !marca.value.trim()) {
                     isValid = false; 
                     if (!firstInvalidElement) firstInvalidElement = marca;
                 }
                 if (!modelo || !modelo.value.trim()) {
                     isValid = false; 
                     if (!firstInvalidElement) firstInvalidElement = modelo;
                 }
                 if (!nroSerie || !nroSerie.value.trim()) {
                     isValid = false; 
                     if (!firstInvalidElement) firstInvalidElement = nroSerie;
                 }

                 // Aplicar/limpiar estilos de error
                 [marguesi, marca, modelo, nroSerie].filter(Boolean).forEach(el => {
                     if (!el.value.trim()) {
                         animateAndFocusInvalid(el);
                         showFieldError(el, "Este campo es obligatorio");
                         if (el.id === 'marguesi' && el.parentElement.classList.contains('input-with-button')) {
                            el.parentElement.classList.add('input-invalid');
                         }
                     } else {
                         el.removeAttribute('aria-invalid');
                         el.classList.remove('input-invalid');
                         clearFieldError(el);
                         if (el.id === 'marguesi' && el.parentElement.classList.contains('input-with-button')) {
                            el.parentElement.classList.remove('input-invalid');
                         }
                     }
                 });

                 if (ip && ip.value.trim()) {
                     ip.removeAttribute('aria-invalid');
                     ip.classList.remove('input-invalid');
                     clearFieldError(ip);
                 }
                 
                 if (!isValid) {
                     showMessage("Por favor, complete todos los campos obligatorios (*) del componente.", 'error');
                 }
                 return isValid;
             }

            /**********************
             * Env√≠o a Google Sheets
             **********************/
            async function sendDataToSheet(data, options = { showOverlay: true, clearOnSuccess: true, attemptNetworkOnly: false }) {
                const payload = {
                    kitCode: data.kitCode,
                    tecnico: data.tecnico,
                    estado: data.estado,
                    sede: data.sede,
                    dependencia: data.dependencia,
                    anexoKit: data.anexoKit,
                    tipoCargo: data.tipoCargo,
                    responsableTipo: data.responsableTipo,
                    responsableNombre: data.responsableNombre,
                    usuarioFinal: data.usuarioFinal,
                    components: data.components 
                };
                 try {
                     if (options.showOverlay) showOverlay(true, 'Enviando datos al servidor...'); 
                     if (options.showOverlay) await simulateProgress(0.15);
                     
                     const response = await fetch(SHEET_URL, {
                         method: 'POST',
                         mode: 'no-cors', 
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify(payload)
                     });
                     
                     // En modo no-cors no podemos verificar la respuesta
                     // Asumimos √©xito si no hay error de red
                     if (options.showOverlay) await simulateProgress(1.0);
                     if (options.showOverlay) showOverlay(false);
                     
                     if (options.clearOnSuccess) {
                         localStorage.removeItem(LS_KEY);
                     }
                     
                     if (!options.attemptNetworkOnly) {
                         showMessage("¬°Datos enviados exitosamente!", 'success');
                         setTimeout(resetForm, 1000);
                     }
                     
                     return true;
                     
                 } catch (error) {
                     if (options.showOverlay) showOverlay(false);
                     console.error('Error al enviar:', error);
                     
                     if (!options.attemptNetworkOnly) {
                         pushPendingSubmission(payload); 
                         showMessage("Error de conexi√≥n. Los datos se guardar√°n localmente y se reintentar√°n autom√°ticamente.", 'warning');
                     } else {
                         showMessage(`Reintento fall√≥ para ${data.kitCode}.`, 'error');
                     }
                     
                     return false;
                 }
            }

            function simulateProgress(target = 1.0) { 
                return new Promise(resolve => {
                    if (dom.progressBar) {
                        dom.progressBar.style.width = `${target * 100}%`;
                    }
                    setTimeout(resolve, target === 1.0 ? 500 : 350);
                });
            }
            
            /**********************
             * Campos din√°micos de Responsable - MEJORADO
             **********************/
            function mostrarCampos() {
                const tipo = (dom.tipoCargo.value || '').toString().trim().toUpperCase();
                const contenedor = dom.camposDinamicos;
                
                // Mostrar indicador de estado
                if (dom.camposStatus) {
                    dom.camposStatus.style.display = tipo ? 'flex' : 'none';
                }
                
                contenedor.innerHTML = ""; 
                if (!tipo) { 
                    if (dom.camposStatus) dom.camposStatus.style.display = 'none';
                    updateLocalSummary(); 
                    return; 
                }

                const bloqueResponsable = `
                    <div class="form-group full-width-field" id="responsable-block">
                       <label for="nombreResponsable">üë§ RESPONSABLE DEL CARGO:* <span class="field-hint">(Persona asignada al equipo)</span></label> 
                       <div class="responsable-group">
                           <select id="tipoResponsable" required class="select-with-icon">
                               <option value="">Seleccione tipo...</option>
                               <option value="728">728</option>
                               <option value="276">276</option>
                               <option value="CAS">CAS</option>
                           </select>
                           <input type="text" id="nombreResponsable" placeholder="Nombre Asignado" required />
                       </div>
                   </div>`;
                
                const bloqueUsuarioFinal = `
                    <div class="form-group full-width-field" id="usuario-final-block">
                       <label for="usuarioFinalName">üë• USUARIO FINAL DEL EQUIPO (TITULAR):* <span class="field-hint">(Persona que usar√° el equipo)</span></label> 
                       <input type="text" id="usuarioFinalName" placeholder="Llenar nombre del usuario final" required />
                   </div>`;

                const isUserFinalRequired = (tipo === "VOL" || tipo === "TER" || tipo === "SEC");
                let htmlContent = bloqueResponsable;
                
                if (isUserFinalRequired) { 
                    htmlContent += bloqueUsuarioFinal; 
                    contenedor.classList.add('stacked'); 
                } else {
                    contenedor.classList.remove('stacked');
                }
                
                contenedor.innerHTML = htmlContent; 

                // Ocultar indicador de estado
                setTimeout(() => {
                    if (dom.camposStatus) {
                        dom.camposStatus.style.display = 'none';
                    }
                }, 500);

                const nombreRespInput = document.getElementById('nombreResponsable');
                const usuarioFinalInput = document.getElementById('usuarioFinalName');
                const tipoRespSelect = document.getElementById('tipoResponsable');

                if (nombreRespInput) {
                    nombreRespInput.addEventListener('input', () => { 
                        updateLocalSummary(); 
                        autosave(); 
                    });
                }
                if (usuarioFinalInput) {
                    usuarioFinalInput.addEventListener('input', () => { 
                        updateLocalSummary(); 
                        autosave(); 
                    });
                }
                if (tipoRespSelect) {
                    tipoRespSelect.addEventListener('change', () => { 
                        updateLocalSummary(); 
                        autosave(); 
                    });
                }

                updateLocalSummary();
            }

            /**********************
             * Resumen local y UI de componentes - MEJORADO
             **********************/
            function updateLocalSummary() { 
                const usuarioFinalNameInput = document.getElementById('usuarioFinalName');
                const nombreResponsableInput = document.getElementById('nombreResponsable');
                let titularName = "PENDIENTE";
                
                if (usuarioFinalNameInput && usuarioFinalNameInput.value.trim()) {
                    titularName = usuarioFinalNameInput.value.toUpperCase().trim();
                } else if (nombreResponsableInput && nombreResponsableInput.value.trim()) {
                    titularName = nombreResponsableInput.value.toUpperCase().trim();
                }

                const componentesResumenLista = document.getElementById('componentesResumenLista');

                if (state.componentes.length > 0) {
                    dom.resumenKit.style.display = "block";
                    dom.kitFinal.textContent = `${dom.codigoKitUsuario.value} - ${titularName}`;
                    
                    componentesResumenLista.innerHTML = state.componentes.map((c, index) => {
                        let parts = [`<strong>[${c.tipo.toUpperCase()}]</strong>`];
                        if (c.codigoKitComp) parts.push(`${c.codigoKitComp}:`);
                        
                        let details = [];
                        if (c.ip) details.push(`IP: ${c.ip}`);
                        if (c.marca && c.modelo) details.push(`${c.marca} ${c.modelo}`);
                        if (c.patrimonial) details.push(`Patr: ${c.patrimonial}`);
                        
                        if (details.length > 0) {
                            parts.push(`<span style="font-style:italic;">${details.join(' | ')}</span>`);
                        }
                        
                        if (c.marguesi) parts.push(`(CB: ${c.marguesi})`);
                        if (c.nro_serie) parts.push(`(SN: ${c.nro_serie})`);
                        
                        return `<li style="margin-bottom:6px;border-bottom:1px dotted #ccc;padding-bottom:4px;font-size:0.9em;">${parts.join(' ')}</li>`;
                    }).join('');
                } else {
                    dom.resumenKit.style.display = "none";
                    componentesResumenLista.innerHTML = '';
                }
             }

            function refreshComponentList() {
                 dom.listaComponentes.innerHTML = '';
                 
                 if (state.componentes.length === 0) {
                     const li = document.createElement('li');
                     li.textContent = "No hay componentes agregados a√∫n.";
                     li.style.color = '#666';
                     li.style.fontStyle = 'italic';
                     dom.listaComponentes.appendChild(li);
                     return;
                 }
                 
                 for (const c of state.componentes) {
                     const li = document.createElement('li');
                     let parts = [`[${c.tipo.toUpperCase()}]`];
                     
                     if (c.codigoKitComp) parts.push(`${c.codigoKitComp}`);
                     if (c.ip) parts.push(`IP: ${c.ip}`);
                     if (c.patrimonial) parts.push(`Patrimonial: ${c.patrimonial}`);
                     if (c.marca) parts.push(`Marca: ${c.marca}`);
                     if (c.modelo) parts.push(`Modelo: ${c.modelo}`);
                     if (c.marguesi) parts.push(`Marguesi: ${c.marguesi}`);
                     if (c.nro_serie) parts.push(`N¬∞ Serie: ${c.nro_serie}`);
                     
                     li.textContent = parts.join(' - ');
                     dom.listaComponentes.appendChild(li);
                 }
            }
            
            function mostrarFormulario(validateBefore = true) {
                const tipoSeleccionado = dom.tipoComponente.value;
                const tipoTexto = dom.tipoComponente.options[dom.tipoComponente.selectedIndex].text;
                
                // Actualizar feedback de componente seleccionado
                if (tipoSeleccionado && dom.componentFeedback && dom.selectedComponentName) {
                    dom.selectedComponentName.textContent = tipoTexto;
                    dom.componentFeedback.style.display = 'block';
                } else if (dom.componentFeedback) {
                    dom.componentFeedback.style.display = 'none';
                }
                
                if (validateBefore && tipoSeleccionado && !validateInfoFields()) {
                    dom.tipoComponente.value = "";
                    dom.formularioComponente.style.display = "none";
                    if (dom.componentFeedback) dom.componentFeedback.style.display = 'none';
                    return;
                }
                
                actualizarCamposPorTipo(tipoSeleccionado); 
                
                const tipo = dom.tipoComponente.value;
                dom.formularioComponente.style.display = tipo ? "block" : "none";
                
                if (tipo) {
                    const codigoKitUsuario = dom.codigoKitUsuario.value;
                    if (!codigoKitUsuario || codigoKitUsuario === "Cargando...") {
                         showMessage("Esperando asignaci√≥n de C√≥digo de KIT...", "info");
                         dom.tipoComponente.value = "";
                         dom.formularioComponente.style.display = "none";
                         if (dom.componentFeedback) dom.componentFeedback.style.display = 'none';
                         return;
                     }

                    const isKitCompRequired = ['cpu', 'monitor', 'teclado', 'laptop', 'docking', 'ups', 'camaraweb'].includes(tipo); 

                    dom.codigoKitCompContainer.style.display = isKitCompRequired ? "block" : "none";
                    
                    if (isKitCompRequired) {
                        if (!state.contador[tipo]) state.contador[tipo] = 1; 
                        const currentCount = state.contador[tipo];
                        const autogen = `${codigoKitUsuario}-${tipo.toUpperCase()}-${String(currentCount).padStart(4, '0')}`;
                        dom.codigoKitComp.value = autogen;
                    } else {
                        dom.codigoKitComp.value = ""; 
                    }

                    if (validateBefore) { 
                        document.getElementById('ip') && (document.getElementById('ip').value = "");
                        document.getElementById('patrimonial') && (document.getElementById('patrimonial').value = "");
                        dom.marguesi.value = "";
                        dom.nro_serie.value = "";
                        dom.marca.value = "";
                        dom.modelo.value = "";
                        dom.codeInfo.style.display = 'none';
                        dom.detectedStrategy.textContent = '--';
                    }

                    stopScanning(false);
                } else if (dom.componentFeedback) {
                    dom.componentFeedback.style.display = 'none';
                }
            }

            function agregarComponente() {
                 if (!validateInfoFields()) return;
                 
                 const tipo = dom.tipoComponente.value;
                 if (!tipo) { 
                     showMessage("Seleccione un Tipo de Componente.", 'error');
                     animateAndFocusInvalid(dom.tipoComponente);
                     return; 
                 }
                 
                 if (!validateComponentFields(tipo)) return;
                 
                 const marguesi = (dom.marguesi.value || '').toUpperCase().trim();
                 const nroSerie = (dom.nro_serie.value || '').toUpperCase().trim();
                 const marca = (dom.marca.value || '').toUpperCase().trim();
                 const modelo = (dom.modelo.value || '').toUpperCase().trim();
                 const ip = (document.getElementById('ip') || {}).value || '';
                 const patrimonial = (document.getElementById('patrimonial') || {}).value || '';

                 let codigoKitComp = "SIN-KIT";
                 const isKitCompRequired = ['cpu', 'monitor', 'teclado', 'laptop', 'docking', 'ups', 'camaraweb'].includes(tipo);
                 
                 if (isKitCompRequired) {
                     codigoKitComp = dom.codigoKitComp.value;
                 } 
                 
                 state.componentes.push({ 
                     tipo, 
                     marguesi: marguesi, 
                     nro_serie: nroSerie, 
                     marca: marca, 
                     modelo: modelo, 
                     codigoKitComp: isKitCompRequired ? codigoKitComp : null, 
                     ip: ip || null,
                     patrimonial: patrimonial || null
                 });

                 if (isKitCompRequired) {
                     state.contador[tipo] = (state.contador[tipo] || 1) + 1;
                 }
                 
                 refreshComponentList();
                 updateLocalSummary();
                 showMessage(`‚úÖ Componente ${tipo.toUpperCase()} agregado correctamente.`, 'success');
                 playScanSound();
                 vibrate([100, 50, 100]);
                 
                 autosave();
                 dom.tipoComponente.value = "";
                 mostrarFormulario(false);
            }

            function resetForm() {
                 // Detener escaneo si est√° activo
                 stopScanning(false);
                 
                 // Resetear todos los campos
                 const allInputs = document.querySelectorAll('input[type="text"]:not([readonly]), select');
                 allInputs.forEach(input => { 
                     if (input.id === 'tipoResponsable') return;
                     if (input.tagName === 'SELECT') {
                         input.value = '';
                     } else {
                         input.value = ''; 
                     }
                     input.removeAttribute('aria-invalid');
                     input.classList.remove('input-invalid');
                     clearFieldError(input);
                 });
                 
                 if (dom.anexoKit) {
                     dom.anexoKit.value = '';
                 }

                 // Limpiar lista de componentes
                 dom.listaComponentes.innerHTML = "";
                 state.componentes = [];
                 
                 // Resetear contadores
                 const defaultContador = { cpu: 1, monitor: 1, teclado: 1, laptop: 1, docking: 1, ups: 1, camaraweb: 1 };
                 state.contador = { ...defaultContador };

                 // Resetear campos din√°micos
                 dom.tipoCargo.value = '';
                 mostrarCampos();
                 
                 // Ocultar feedback y resumen
                 dom.resumenKit.style.display = "none";
                 dom.formularioComponente.style.display = "none";
                 if (dom.componentFeedback) dom.componentFeedback.style.display = 'none';
                 
                 // Limpiar localStorage
                 localStorage.removeItem(LS_KEY);
                 
                 // Obtener nuevo c√≥digo de KIT
                 dom.codigoKitUsuario.value = "Cargando...";
                 getNewKitCode();
                 
                 showMessage("Formulario reiniciado. Puede comenzar un nuevo registro.", 'info');
            }

            function enviarFormulario() {
                 if (!validateInfoFields()) return;
                 
                 if (state.componentes.length === 0) { 
                     showMessage("Debe agregar al menos un componente antes de enviar.", 'error');
                     animateAndFocusInvalid(dom.tipoComponente); 
                     return; 
                 }
                 
                 const tipoResponsableInput = document.getElementById('tipoResponsable');
                 const nombreResponsableInput = document.getElementById('nombreResponsable');
                 const usuarioFinalNameInput = document.getElementById('usuarioFinalName');
                 
                 const nombreResponsable = nombreResponsableInput ? nombreResponsableInput.value.toUpperCase().trim() : "";
                 const nombreUsuarioFinal = (usuarioFinalNameInput && usuarioFinalNameInput.value) 
                     ? usuarioFinalNameInput.value.toUpperCase().trim() 
                     : nombreResponsable;
                 
                 const submissionData = {
                     kitCode: dom.codigoKitUsuario.value, 
                     estado: dom.estado.options[dom.estado.selectedIndex].value,
                     tecnico: dom.tecnicoResponsable.options[dom.tecnicoResponsable.selectedIndex].text,
                     sede: dom.sede.options[dom.sede.selectedIndex].text,
                     dependencia: dom.dependencia.options[dom.dependencia.selectedIndex].text,
                     anexoKit: (dom.anexoKit || {}).value || '',
                     tipoCargo: dom.tipoCargo.options[dom.tipoCargo.selectedIndex].text,
                     responsableTipo: tipoResponsableInput ? tipoResponsableInput.value : "N/A",
                     responsableNombre: nombreResponsable,
                     usuarioFinal: nombreUsuarioFinal,
                     components: state.componentes
                 };

                 sendDataToSheet(submissionData, { showOverlay: true, clearOnSuccess: true, attemptNetworkOnly: false });
            }

            /**********************
             * Obtener nuevo KIT ID
             **********************/
            async function getNewKitCode() { 
                let finalKitCode = "KIT-0001";
                try {
                    dom.codigoKitUsuario.value = "Cargando...";
                    
                    const response = await fetch(SHEET_URL + '?action=getKitCode');
                    if (!response.ok) {
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    if (data.result === "success" && data.nextKitCode) {
                        finalKitCode = data.nextKitCode;
                        showMessage(`ID de KIT asignado: ${finalKitCode}`, 'success');
                    } else {
                        throw new Error(data.message || "Respuesta inv√°lida del servidor");
                    }
                } catch (error) {
                    console.error('Error al obtener el nuevo KIT ID:', error);
                    
                    if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                         showMessage("Error de conexi√≥n. Usando ID por defecto. Los datos se guardar√°n localmente.", 'warning');
                    } else {
                         showMessage(`Error al obtener ID: ${error.message}. Usando ID por defecto.`, 'error');
                    }
                    
                    finalKitCode = "KIT-0001"; 
                } finally {
                    dom.codigoKitUsuario.value = finalKitCode;
                    restoreAutosave();
                }
            }
            
            function actualizarCamposPorTipo(tipo) {
                 const ipGroup = document.getElementById('ip-group');
                 const marguesiGroup = document.getElementById('marguesi-group');
                 const patrimonialGroup = document.getElementById('patrimonial-group');
                 const marcaGroup = document.getElementById('marca-group');
                 const modeloGroup = document.getElementById('modelo-group');
                 const nroSerieGroup = document.getElementById('nro_serie-group');

                 // Determinar qu√© dispositivos requieren IP (seg√∫n requerimiento)
                 const devicesWithIP = ['cpu', 'laptop', 'fotocopiadora', 'impresora', 'escaner'];
                 const mostrarIP = devicesWithIP.includes(tipo);
                 
                 ipGroup.style.display = mostrarIP ? 'block' : 'none';

                 const mostrarCamposEstandar = tipo !== ''; 
                 marguesiGroup.style.display = mostrarCamposEstandar ? 'block' : 'none';
                 patrimonialGroup.style.display = mostrarCamposEstandar ? 'block' : 'none';
                 marcaGroup.style.display = mostrarCamposEstandar ? 'block' : 'none';
                 modeloGroup.style.display = mostrarCamposEstandar ? 'block' : 'none';
                 nroSerieGroup.style.display = mostrarCamposEstandar ? 'block' : 'none';
                 
                 // Limpiar errores de validaci√≥n
                 [document.getElementById('ip'), dom.marguesi, document.getElementById('patrimonial'), dom.marca, dom.modelo, dom.nro_serie]
                     .filter(Boolean)
                     .forEach(el => {
                         el.removeAttribute('aria-invalid');
                         el.classList.remove('input-invalid');
                         clearFieldError(el);
                         if (el.id === 'marguesi' && el.parentElement.classList.contains('input-with-button')) {
                            el.parentElement.classList.remove('input-invalid');
                         }
                     });
             }

            /***************************************************************
             * SISTEMA DE ESC√ÅNER MULTI-ESTRATEGIA - VERSI√ìN AVANZADA
             * 4 estrategias de detecci√≥n:
             * 1. ZXing directo
             * 2. ZXing con imagen mejorada
             * 3. OCR Tesseract
             * 4. Captura manual
             ***************************************************************/

            // Actualizar indicadores de estrategia
            function updateStrategyIndicators() {
                // Actualizar puntos indicadores
                [dom.strategyDot1, dom.strategyDot2, dom.strategyDot3, dom.strategyDot4]
                    .forEach((dot, index) => {
                        if (dot) {
                            if (index === state.currentStrategy) {
                                dot.classList.add('active');
                            } else {
                                dot.classList.remove('active');
                            }
                        }
                    });
                
                // Actualizar panel de estrategias
                state.strategies.forEach((strategy, index) => {
                    const statusElement = [dom.strategyStatus1, dom.strategyStatus2, 
                                         dom.strategyStatus3, dom.strategyStatus4][index];
                    if (statusElement) {
                        if (strategy.success) {
                            statusElement.className = 'strategy-status active';
                        } else if (strategy.used) {
                            statusElement.className = 'strategy-status inactive';
                        } else {
                            statusElement.className = 'strategy-status';
                        }
                    }
                });
            }

            // Inicializar ZXing de forma segura
            async function initZXing() {
                try {
                    if (typeof ZXing === 'undefined') {
                        console.error('ZXing no est√° cargado');
                        showMessage("Error: Biblioteca de escaneo no disponible.", 'error');
                        return false;
                    }
                    
                    // Limpiar lector anterior si existe
                    if (state.codeReader) {
                        try {
                            state.codeReader.reset();
                        } catch (e) {
                            console.warn("Error al resetear codeReader anterior:", e);
                        }
                        state.codeReader = null;
                    }
                    
                    // Configurar hints para mejor detecci√≥n
                    const hints = new Map();
                    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
                        ZXing.BarcodeFormat.CODE_128,
                        ZXing.BarcodeFormat.CODE_39,
                        ZXing.BarcodeFormat.EAN_13,
                        ZXing.BarcodeFormat.EAN_8,
                        ZXing.BarcodeFormat.CODE_93,
                        ZXing.BarcodeFormat.CODABAR,
                        ZXing.BarcodeFormat.ITF,
                        ZXing.BarcodeFormat.UPC_A,
                        ZXing.BarcodeFormat.UPC_E
                    ]);
                    hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
                    hints.set(ZXing.DecodeHintType.PURE_BARCODE, false);
                    
                    state.codeReader = new ZXing.BrowserMultiFormatReader(hints);
                    console.log("ZXing inicializado correctamente");
                    
                    return true;
                } catch (error) {
                    console.error("Error al inicializar ZXing:", error);
                    return false;
                }
            }

            // Decodificar usando ZXing (Estrategia 1)
            async function decodeWithZXing(videoElement) {
                try {
                    if (!state.codeReader) return null;
                    state.currentStrategy = 0;
                    updateStrategyIndicators();
                    
                    const result = await state.codeReader.decodeFromVideoElement(videoElement);
                    if (result && result.text) {
                        state.strategies[0].success = true;
                        state.strategies[0].used = true;
                        return result.text.trim();
                    }
                } catch (error) {
                    state.strategies[0].used = true;
                    state.strategies[0].success = false;
                }
                return null;
            }

            // Decodificar usando ZXing con imagen mejorada (Estrategia 2)
            async function decodeWithZXingEnhanced(videoElement) {
                try {
                    if (!state.codeReader || !state.currentCanvas) return null;
                    state.currentStrategy = 1;
                    updateStrategyIndicators();
                    
                    // Mejorar imagen primero
                    const enhancedCanvas = enhanceImage(state.currentCanvas);
                    const result = await state.codeReader.decodeFromCanvas(enhancedCanvas);
                    
                    if (result && result.text) {
                        state.strategies[1].success = true;
                        state.strategies[1].used = true;
                        return result.text.trim();
                    }
                } catch (error) {
                    state.strategies[1].used = true;
                    state.strategies[1].success = false;
                }
                return null;
            }

            // Decodificar usando OCR (Estrategia 3)
            async function decodeWithOCR(videoElement) {
                try {
                    state.currentStrategy = 2;
                    updateStrategyIndicators();
                    
                    if (!OCRSystem.isInitialized) {
                        const initialized = await OCRSystem.init();
                        if (!initialized) return null;
                    }
                    
                    // Capturar frame actual
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = videoElement.videoWidth;
                    canvas.height = videoElement.videoHeight;
                    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                    
                    // Aplicar preprocesamiento para OCR
                    const processedCanvas = preprocessForOCR(canvas);
                    
                    // Realizar OCR
                    const text = await OCRSystem.recognizeFromCanvas(processedCanvas);
                    
                    if (text && text.length >= 6) { // M√≠nimo 6 caracteres para ser v√°lido
                        state.strategies[2].success = true;
                        state.strategies[2].used = true;
                        return text;
                    }
                } catch (error) {
                    state.strategies[2].used = true;
                    state.strategies[2].success = false;
                    console.warn("OCR fall√≥:", error);
                }
                return null;
            }

            // Preprocesar imagen para OCR
            function preprocessForOCR(canvas) {
                const ctx = canvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // Convertir a escala de grises y aumentar contraste
                for (let i = 0; i < data.length; i += 4) {
                    const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                    
                    // Umbralizaci√≥n adaptativa
                    const threshold = 128;
                    const binary = gray > threshold ? 255 : 0;
                    
                    data[i] = binary;     // R
                    data[i + 1] = binary; // G
                    data[i + 2] = binary; // B
                }
                
                ctx.putImageData(imageData, 0, 0);
                return canvas;
            }

            // Decodificar usando captura manual (Estrategia 4)
            async function decodeWithManualCapture() {
                try {
                    state.currentStrategy = 3;
                    updateStrategyIndicators();
                    
                    if (!state.currentCanvas) return null;
                    
                    // Intentar todas las estrategias en orden
                    let result = null;
                    
                    // 1. ZXing directo
                    if (state.codeReader) {
                        try {
                            result = await state.codeReader.decodeFromCanvas(state.currentCanvas);
                            if (result && result.text) {
                                state.strategies[3].success = true;
                                return result.text.trim();
                            }
                        } catch (e) {}
                    }
                    
                    // 2. ZXing con imagen mejorada
                    if (!result && state.codeReader) {
                        try {
                            const enhanced = enhanceImage(state.currentCanvas);
                            result = await state.codeReader.decodeFromCanvas(enhanced);
                            if (result && result.text) {
                                state.strategies[3].success = true;
                                return result.text.trim();
                            }
                        } catch (e) {}
                    }
                    
                    // 3. OCR
                    if (!result && OCRSystem.isInitialized) {
                        try {
                            const processed = preprocessForOCR(state.currentCanvas);
                            result = await OCRSystem.recognizeFromCanvas(processed);
                            if (result && result.length >= 6) {
                                state.strategies[3].success = true;
                                return result;
                            }
                        } catch (e) {}
                    }
                    
                    state.strategies[3].used = true;
                    state.strategies[3].success = false;
                    return null;
                    
                } catch (error) {
                    state.strategies[3].used = true;
                    state.strategies[3].success = false;
                    return null;
                }
            }

            // Decodificaci√≥n continua usando m√∫ltiples estrategias
            async function decodeWithMultiStrategy() {
                if (!state.scanning || !dom.videoElement) return null;
                
                try {
                    // Resetear estado de estrategias
                    state.strategies.forEach(s => {
                        s.used = false;
                        s.success = false;
                        s.active = false;
                    });
                    
                    state.currentStrategy = 0;
                    
                    // Mostrar indicadores
                    if (dom.scanStrategyIndicator) {
                        dom.scanStrategyIndicator.style.display = 'flex';
                    }
                    if (dom.scanStrategiesPanel) {
                        dom.scanStrategiesPanel.style.display = 'block';
                    }
                    
                    updateStrategyIndicators();
                    
                    let detectedCode = null;
                    let strategyUsed = '';
                    
                    // Estrategia 1: ZXing directo
                    state.strategies[0].active = true;
                    updateStrategyIndicators();
                    detectedCode = await decodeWithZXing(dom.videoElement);
                    if (detectedCode) {
                        strategyUsed = 'ZXing Directo';
                        dom.detectedStrategy.textContent = strategyUsed;
                        return { code: detectedCode, strategy: strategyUsed };
                    }
                    
                    // Estrategia 2: ZXing con imagen mejorada
                    state.strategies[1].active = true;
                    updateStrategyIndicators();
                    
                    // Capturar frame para procesamiento
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = dom.videoElement.videoWidth;
                    canvas.height = dom.videoElement.videoHeight;
                    ctx.drawImage(dom.videoElement, 0, 0);
                    state.currentCanvas = canvas;
                    
                    detectedCode = await decodeWithZXingEnhanced(dom.videoElement);
                    if (detectedCode) {
                        strategyUsed = 'ZXing + Imagen Mejorada';
                        dom.detectedStrategy.textContent = strategyUsed;
                        return { code: detectedCode, strategy: strategyUsed };
                    }
                    
                    // Estrategia 3: OCR Tesseract
                    state.strategies[2].active = true;
                    updateStrategyIndicators();
                    detectedCode = await decodeWithOCR(dom.videoElement);
                    if (detectedCode) {
                        strategyUsed = 'OCR Tesseract';
                        dom.detectedStrategy.textContent = strategyUsed;
                        return { code: detectedCode, strategy: strategyUsed };
                    }
                    
                    // Estrategia 4: Captura manual (si est√° activo)
                    if (state.isManualMode && state.currentCanvas) {
                        state.strategies[3].active = true;
                        updateStrategyIndicators();
                        detectedCode = await decodeWithManualCapture();
                        if (detectedCode) {
                            strategyUsed = 'Captura Manual';
                            dom.detectedStrategy.textContent = strategyUsed;
                            return { code: detectedCode, strategy: strategyUsed };
                        }
                    }
                    
                    // Si ninguna estrategia funcion√≥
                    dom.detectedStrategy.textContent = 'Ninguna estrategia funcion√≥';
                    return null;
                    
                } catch (error) {
                    console.error("Error en estrategia m√∫ltiple:", error);
                    return null;
                }
            }

            // Iniciar escaneo - VERSI√ìN MULTI-ESTRATEGIA
            async function startScanning() {
                console.log("Iniciando escaneo multi-estrategia...");
                
                if (state.scanning) {
                    console.log("Ya est√° escaneando, deteniendo primero...");
                    stopScanning(false);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                // Verificar permisos de c√°mara
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showMessage("Tu navegador no soporta el acceso a la c√°mara.", 'error');
                    return;
                }
                
                // Mostrar consejos
                if (dom.scanTips) {
                    dom.scanTips.style.display = 'block';
                }
                
                try {
                    state.scanning = true;
                    state.scanCount = 0;
                    state.validCodes = 0;
                    state.scanAttempts = 0;
                    state.isManualMode = false;
                    
                    // Resetear estrategias
                    state.strategies.forEach(s => {
                        s.active = false;
                        s.used = false;
                        s.success = false;
                    });
                    
                    // Mostrar UI de escaneo
                    dom.videoContainer.style.display = "block";
                    dom.retryBtn.style.display = "none";
                    
                    if (dom.scanBtnMarguesi) {
                        dom.scanBtnMarguesi.classList.add('scanning');
                    }
                    
                    dom.scanStats.textContent = "Iniciando sistema multi-estrategia...";
                    
                    // Limpiar cualquier stream anterior
                    await cleanupStream();
                    
                    // Configuraci√≥n optimizada para el dispositivo
                    const deviceSettings = DeviceOptimizer.getOptimalCameraSettings();
                    const constraints = {
                        video: {
                            ...deviceSettings.video,
                            facingMode: state.currentFacingMode
                        }
                    };
                    
                    console.log("Solicitando c√°mara con constraints:", constraints);
                    
                    // Solicitar acceso a la c√°mara
                    state.currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    // Verificar que el stream sea v√°lido
                    if (!state.currentStream || !state.currentStream.active) {
                        throw new Error('Stream de c√°mara no activo');
                    }
                    
                    // Asignar stream al elemento de video
                    dom.videoElement.srcObject = state.currentStream;
                    
                    // Esperar a que el video est√© listo
                    await new Promise((resolve, reject) => {
                        let resolved = false;
                        
                        const onReady = () => {
                            if (resolved) return;
                            resolved = true;
                            console.log("Video listo para reproducir");
                            dom.videoElement.play().then(resolve).catch(reject);
                        };
                        
                        if (dom.videoElement.readyState >= 3) {
                            onReady();
                        } else {
                            dom.videoElement.onloadedmetadata = onReady;
                            dom.videoElement.oncanplay = onReady;
                        }
                        
                        // Timeout de seguridad
                        setTimeout(() => {
                            if (!resolved) {
                                resolved = true;
                                if (dom.videoElement.readyState >= 2) {
                                    dom.videoElement.play().then(resolve).catch(reject);
                                } else {
                                    reject(new Error('Timeout al cargar video'));
                                }
                            }
                        }, 10000);
                    });
                    
                    // Inicializar ZXing si no est√° inicializado
                    if (!state.codeReader) {
                        const initialized = await initZXing();
                        if (!initialized) {
                            console.warn("ZXing no inicializado, usando solo OCR");
                        }
                    }
                    
                    // Inicializar OCR si no est√° inicializado
                    if (!OCRSystem.isInitialized) {
                        await OCRSystem.init();
                    }
                    
                    // Actualizar UI
                    dom.scanStats.textContent = "Sistema multi-estrategia activo";
                    dom.scannerActiveIndicator.style.display = 'block';
                    showMessage("Sistema multi-estrategia activado. Escaneando...", 'info');
                    
                    // Detectar capacidades de la c√°mara
                    detectCameraCapabilities();
                    
                    // Iniciar decodificaci√≥n continua
                    state.isCameraInitialized = true;
                    decodeContinuouslyMultiStrategy();
                    
                } catch (error) {
                    console.error("Error cr√≠tico al iniciar c√°mara:", error);
                    
                    let errorMessage = "Error al acceder a la c√°mara";
                    
                    if (error.name === 'NotAllowedError') {
                        errorMessage = "Permiso de c√°mara denegado. Por favor, permita el acceso a la c√°mara en la configuraci√≥n del navegador.";
                    } else if (error.name === 'NotFoundError') {
                        errorMessage = "No se encontr√≥ c√°mara en el dispositivo.";
                    } else if (error.name === 'NotSupportedError') {
                        errorMessage = "El navegador no soporta esta funcionalidad.";
                    } else if (error.name === 'NotReadableError') {
                        errorMessage = "La c√°mara est√° en uso por otra aplicaci√≥n.";
                    } else if (error.name === 'OverconstrainedError') {
                        errorMessage = "No se puede acceder a la c√°mara con la configuraci√≥n solicitada.";
                    } else if (error.message.includes('Timeout')) {
                        errorMessage = "Timeout al cargar la c√°mara. Intente nuevamente.";
                    } else {
                        errorMessage = `Error de c√°mara: ${error.message || error}`;
                    }
                    
                    showMessage(errorMessage, 'error');
                    stopScanning(true);
                }
            }

            // Decodificaci√≥n continua multi-estrategia
            async function decodeContinuouslyMultiStrategy() {
                if (!state.scanning || !dom.videoElement) {
                    console.log("Decodificaci√≥n detenida");
                    return;
                }
                
                try {
                    // Verificar que el video est√© listo
                    if (dom.videoElement.readyState < 2 || dom.videoElement.paused) {
                        console.log("Video no listo, reintentando...");
                        setTimeout(decodeContinuouslyMultiStrategy, 300);
                        return;
                    }
                    
                    state.scanAttempts++;
                    
                    // Limitar intentos para evitar loops infinitos
                    if (state.scanAttempts > state.maxScanAttempts) {
                        console.log("L√≠mite de intentos alcanzado");
                        showMessage("No se detectaron c√≥digos. Intente con 'Mejorar imagen' o 'Capturar manual'.", 'warning');
                        return;
                    }
                    
                    // Intentar decodificar con estrategia m√∫ltiple
                    const result = await decodeWithMultiStrategy();
                    
                    if (result && result.code) {
                        const now = Date.now();
                        
                        // Debounce para evitar m√∫ltiples lecturas del mismo c√≥digo
                        if (now - state.lastScanTimestamp < 1500) {
                            setTimeout(decodeContinuouslyMultiStrategy, 500);
                            return;
                        }
                        
                        state.lastScanTimestamp = now;
                        state.scanCount++;
                        
                        const code = result.code.trim();
                        console.log("C√≥digo detectado con estrategia:", result.strategy, "C√≥digo:", code);
                        
                        // Validar el c√≥digo
                        const validation = PatrimonialValidator.validateCode(code);
                        
                        // Actualizar estad√≠sticas
                        dom.scanStats.textContent = `Escaneos: ${state.scanCount} | V√°lidos: ${state.validCodes} | Estrategia: ${result.strategy}`;
                        
                        if (validation.isValid) {
                            state.validCodes++;
                            
                            // Feedback visual y sonoro
                            playScanSound();
                            vibrate([100, 50, 100]);
                            flashFrame();
                            
                            // Mostrar informaci√≥n detallada del c√≥digo
                            dom.codeInfo.style.display = 'block';
                            dom.detectedType.textContent = validation.tipo;
                            dom.detectedFormat.textContent = validation.descripcion;
                            dom.detectedValidation.textContent = '‚úÖ V√ÅLIDO';
                            dom.detectedValidation.style.color = '#4CAF50';
                            dom.detectedStrategy.textContent = result.strategy;
                            
                            // Aplicar clase de color seg√∫n tipo
                            dom.codeInfo.className = '';
                            dom.codeInfo.classList.add(validation.colorClass || '');
                            
                            // Llenar el campo correspondiente
                            if (state.activeInput) {
                                state.activeInput.value = validation.codigo;
                                state.activeInput.dispatchEvent(new Event('input', { bubbles: true }));
                                
                                // Limpiar errores
                                state.activeInput.removeAttribute('aria-invalid');
                                state.activeInput.classList.remove('input-invalid');
                                
                                if(state.activeInput.parentElement.classList.contains('input-with-button')) {
                                    state.activeInput.parentElement.classList.remove('input-invalid');
                                }
                            }
                            
                            showMessage(`‚úÖ C√≥digo ${validation.tipo} detectado (${result.strategy}): ${validation.codigo}`, 'success');
                            
                            // Detener escaneo despu√©s de lectura exitosa
                            setTimeout(() => {
                                stopScanning(false);
                            }, 1500);
                            
                        } else {
                            // C√≥digo no v√°lido
                            dom.detectedValidation.textContent = '‚ö†Ô∏è NO RECONOCIDO';
                            dom.detectedValidation.style.color = '#FF9800';
                            
                            vibrate(300);
                            showMessage("C√≥digo no reconocido. Intente con otro c√≥digo.", 'warning');
                            
                            // Continuar escaneando
                            setTimeout(decodeContinuouslyMultiStrategy, 500);
                        }
                        
                    } else {
                        // No se detect√≥ c√≥digo, continuar escaneando
                        if (state.scanAttempts % 5 === 0) {
                            dom.scanStats.textContent = `Escaneando... (${state.scanAttempts} intentos, ${state.strategies.filter(s => s.used).length} estrategias usadas)`;
                        }
                        
                        // Continuar loop
                        requestAnimationFrame(() => {
                            if (state.scanning) {
                                decodeContinuouslyMultiStrategy();
                            }
                        });
                    }
                    
                } catch (error) {
                    console.warn("Error en decodificaci√≥n continua:", error);
                    
                    // Continuar escaneando incluso despu√©s de error
                    if (state.scanning) {
                        setTimeout(decodeContinuouslyMultiStrategy, 100);
                    }
                }
            }

            // Detectar capacidades de la c√°mara
            function detectCameraCapabilities() {
                if (!state.currentStream) return;
                
                try {
                    const track = state.currentStream.getVideoTracks()[0];
                    if (track) {
                        const capabilities = track.getCapabilities();
                        const settings = track.getSettings();
                        
                        console.log("Capacidades de c√°mara:", capabilities);
                        console.log("Configuraci√≥n actual:", settings);
                        
                        // Verificar linterna
                        state.torchAvailable = !!capabilities.torch;
                        
                        // Verificar zoom
                        state.zoomAvailable = !!capabilities.zoom && capabilities.zoom.max > 1;
                        if (state.zoomAvailable && dom.zoomControls) {
                            dom.zoomControls.style.display = 'flex';
                            if (dom.zoomSlider) {
                                dom.zoomSlider.min = capabilities.zoom.min || 1;
                                dom.zoomSlider.max = capabilities.zoom.max || 5;
                                dom.zoomSlider.value = settings.zoom || 1;
                            }
                        }
                        
                        // Mostrar/ocultar bot√≥n de linterna
                        if (dom.toggleTorchBtn) {
                            dom.toggleTorchBtn.style.display = state.torchAvailable ? 'flex' : 'none';
                        }
                    }
                } catch (error) {
                    console.warn("Error al detectar capacidades de c√°mara:", error);
                }
            }

            // Limpiar stream de c√°mara
            async function cleanupStream() {
                if (state.currentStream) {
                    try {
                        const tracks = state.currentStream.getTracks();
                        tracks.forEach(track => {
                            try {
                                track.stop();
                                track.enabled = false;
                            } catch (e) {
                                console.warn("Error al detener track:", e);
                            }
                        });
                        state.currentStream = null;
                    } catch (e) {
                        console.warn("Error al limpiar stream:", e);
                    }
                }
                
                if (dom.videoElement) {
                    dom.videoElement.srcObject = null;
                    dom.videoElement.pause();
                }
            }

            // Detener escaneo
            function stopScanning(showRetry = true) {
                console.log("Deteniendo escaneo multi-estrategia...");
                
                if (!state.scanning && !state.currentStream) {
                    return;
                }
                
                state.scanning = false;
                state.isManualMode = false;
                state.imageProcessingEnabled = false;
                
                // Limpiar stream
                cleanupStream();
                
                // Resetear ZXing si existe
                if (state.codeReader) {
                    try {
                        state.codeReader.reset();
                    } catch (e) {
                        console.warn("Error al resetear codeReader:", e);
                    }
                }
                
                // Resetear estrategias
                state.strategies.forEach(s => {
                    s.active = false;
                });
                state.currentStrategy = 0;
                
                // Actualizar UI
                dom.videoContainer.style.display = "none";
                
                if (dom.scanBtnMarguesi) {
                    dom.scanBtnMarguesi.classList.remove('scanning');
                }
                
                if (dom.scannerActiveIndicator) {
                    dom.scannerActiveIndicator.style.display = 'none';
                }
                
                if (dom.scanStrategyIndicator) {
                    dom.scanStrategyIndicator.style.display = 'none';
                }
                
                if (dom.scanStrategiesPanel) {
                    dom.scanStrategiesPanel.style.display = 'none';
                }
                
                dom.retryBtn.style.display = showRetry ? "block" : "none";
                dom.codeInfo.style.display = 'none';
                
                if (dom.scanTips) {
                    dom.scanTips.style.display = 'none';
                }
                
                // Resetear estad√≠sticas
                state.scanCount = 0;
                state.validCodes = 0;
                state.scanAttempts = 0;
                state.lastScanTimestamp = 0;
                
                if (showRetry) {
                    showMessage("Escaneo detenido. Use 'Volver a intentar escaneo' para reiniciar.", 'info');
                }
            }

            // Capturar imagen manualmente
            async function captureManualImage() {
                if (!state.currentStream || !dom.videoElement) {
                    showMessage("Active la c√°mara primero.", 'warning');
                    return;
                }
                
                try {
                    state.isManualMode = true;
                    
                    // Crear canvas para captura
                    const canvas = dom.captureCanvas;
                    const video = dom.videoElement;
                    
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // Guardar canvas para procesamiento
                    state.currentCanvas = canvas;
                    
                    showMessage("Imagen capturada. Procesando con m√∫ltiples estrategias...", 'info');
                    
                    // Intentar decodificar con estrategias m√∫ltiples
                    const result = await decodeWithMultiStrategy();
                    
                    if (result && result.code) {
                        const validation = PatrimonialValidator.validateCode(result.code.trim());
                        
                        if (validation.isValid && state.activeInput) {
                            state.activeInput.value = validation.codigo;
                            state.activeInput.dispatchEvent(new Event('input', { bubbles: true }));
                            
                            showMessage(`‚úÖ C√≥digo detectado (${result.strategy}): ${validation.codigo}`, 'success');
                            playScanSound();
                            vibrate([100, 50, 100]);
                            
                            // Detener escaneo
                            setTimeout(() => {
                                stopScanning(false);
                            }, 1000);
                        } else {
                            showMessage("No se detect√≥ c√≥digo v√°lido en la imagen.", 'warning');
                        }
                    } else {
                        showMessage("No se pudo leer c√≥digo en la imagen capturada.", 'warning');
                    }
                    
                } catch (error) {
                    console.error("Error en captura manual:", error);
                    showMessage("Error al procesar imagen capturada.", 'error');
                }
            }

            // Mejorar imagen para c√≥digos borrosos
            function enhanceImageForBlurryCodes() {
                if (!state.currentCanvas) {
                    showMessage("Capture una imagen primero o active la c√°mara.", 'warning');
                    return;
                }
                
                try {
                    const canvas = state.currentCanvas;
                    const enhancedCanvas = enhanceImage(canvas);
                    
                    state.imageProcessingEnabled = true;
                    state.currentCanvas = enhancedCanvas;
                    
                    showMessage("Imagen mejorada. Intente escanear nuevamente.", 'info');
                    
                    // Si estamos en modo manual, intentar decodificar
                    if (state.isManualMode) {
                        setTimeout(async () => {
                            const result = await decodeWithMultiStrategy();
                            if (result && result.code) {
                                const validation = PatrimonialValidator.validateCode(result.code.trim());
                                if (validation.isValid && state.activeInput) {
                                    state.activeInput.value = validation.codigo;
                                    state.activeInput.dispatchEvent(new Event('input', { bubbles: true }));
                                    
                                    showMessage(`‚úÖ C√≥digo detectado despu√©s de mejora (${result.strategy}): ${validation.codigo}`, 'success');
                                    playScanSound();
                                    vibrate([100, 50, 100]);
                                    
                                    setTimeout(() => {
                                        stopScanning(false);
                                    }, 1000);
                                }
                            }
                        }, 500);
                    }
                    
                } catch (error) {
                    console.error("Error al mejorar imagen:", error);
                    showMessage("Error al procesar imagen.", 'error');
                }
            }

            // Cambiar c√°mara (frontal/trasera)
            async function switchCamera() {
                if (!state.scanning) {
                    showMessage("Active el esc√°ner primero.", 'warning');
                    return;
                }
                
                try {
                    // Alternar entre c√°maras
                    state.currentFacingMode = state.currentFacingMode === 'environment' ? 'user' : 'environment';
                    
                    showMessage(`Cambiando a c√°mara ${state.currentFacingMode === 'environment' ? 'trasera' : 'frontal'}...`, 'info');
                    
                    // Detener y reiniciar
                    const wasScanning = state.scanning;
                    stopScanning(false);
                    
                    if (wasScanning) {
                        setTimeout(() => {
                            startScanning();
                        }, 800);
                    }
                    
                } catch (error) {
                    console.error("Error al cambiar c√°mara:", error);
                    showMessage("No se pudo cambiar la c√°mara.", 'error');
                }
            }

            // Alternar linterna
            async function toggleTorch() {
                if (!state.currentStream || !state.torchAvailable) {
                    showMessage("Linterna no disponible en este dispositivo.", 'warning');
                    return;
                }
                
                try {
                    const track = state.currentStream.getVideoTracks()[0];
                    const constraints = track.getConstraints();
                    
                    let torchState = false;
                    if (constraints.advanced) {
                        const torchConstraint = constraints.advanced.find(c => c.torch);
                        torchState = torchConstraint ? torchConstraint.torch : false;
                    }
                    
                    await track.applyConstraints({
                        advanced: [{ torch: !torchState }]
                    });
                    
                    showMessage(`Linterna ${!torchState ? 'encendida' : 'apagada'}`, 'info');
                    
                } catch (err) {
                    console.error('Error al cambiar la linterna:', err);
                    showMessage("No se pudo controlar la linterna", 'error');
                }
            }

            /**********************
             * Inicializaci√≥n y listeners
             **********************/
            function initApp() {
                console.log("Inicializando aplicaci√≥n multi-estrategia...");
                
                // Detectar dispositivo y capacidades
                state.deviceInfo = DeviceOptimizer.detectDevice();
                
                // Asignar refs principales
                dom.tecnicoResponsable = document.getElementById("tecnicoResponsable");
                dom.sede = document.getElementById("sede");
                dom.dependencia = document.getElementById("dependencia");
                dom.estado = document.getElementById("estado");
                dom.anexoKit = document.getElementById("anexoKit");
                
                // Pre-inicializar ZXing y OCR (sin c√°mara a√∫n)
                Promise.all([
                    initZXing(),
                    OCRSystem.init()
                ]).then(([zxingSuccess, ocrSuccess]) => {
                    console.log(`ZXing: ${zxingSuccess ? 'OK' : 'Fall√≥'}, OCR: ${ocrSuccess ? 'OK' : 'Fall√≥'}`);
                    if (!zxingSuccess && !ocrSuccess) {
                        console.warn("Ambos sistemas de escaneo fallaron, solo entrada manual disponible");
                    }
                });
                
                // Obtener KIT ID
                getNewKitCode(); 
                
                // === LISTENERS PARA FORMULARIO ===
                
                // Autosave en campos generales
                if (dom.anexoKit) {
                    dom.anexoKit.addEventListener('input', () => { 
                        autosave();
                        if (dom.anexoKit.hasAttribute('aria-invalid') && 
                            (!dom.anexoKit.value.trim() || /^\d{5}$/.test(dom.anexoKit.value.trim()))) {
                            dom.anexoKit.removeAttribute('aria-invalid');
                            dom.anexoKit.classList.remove('input-invalid');
                            clearFieldError(dom.anexoKit);
                        }
                    });
                }

                if (dom.tecnicoResponsable) {
                    dom.tecnicoResponsable.addEventListener('change', autosave);
                }
                if (dom.sede) {
                    dom.sede.addEventListener('change', autosave);
                }
                if (dom.dependencia) {
                    dom.dependencia.addEventListener('change', autosave);
                }
                if (dom.estado) {
                    dom.estado.addEventListener('change', autosave);
                }
                
                dom.tipoCargo.addEventListener('change', () => { 
                    mostrarCampos(); 
                    autosave(); 
                });
                 
                // Convertir a may√∫sculas autom√°ticamente
                document.querySelectorAll('input[type="text"]:not([readonly])').forEach(input => {
                    if (input.id !== 'ip' && input.id !== 'anexoKit') { 
                        input.addEventListener('input', () => {
                            input.value = input.value.toUpperCase();
                            autosave();
                        });
                    } else { 
                        input.addEventListener('input', autosave);
                    }
                });
                 
                // === LISTENERS PARA EL ESC√ÅNER MULTI-ESTRATEGIA ===
                
                // Bot√≥n de escaneo para Marguesi
                if (dom.scanBtnMarguesi) {
                    dom.scanBtnMarguesi.addEventListener("click", (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        console.log("Bot√≥n de escaneo clickeado");
                        state.activeInput = dom.marguesi;
                        
                        startScanning();
                    });
                }
                
                // Bot√≥n de reintentar
                if (dom.retryBtn) {
                    dom.retryBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        console.log("Bot√≥n de reintento clickeado");
                        state.activeInput = dom.marguesi;
                        startScanning();
                    });
                }
                 
                // Bot√≥n de mejora de imagen
                if (dom.enhanceImageBtn) {
                    dom.enhanceImageBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        enhanceImageForBlurryCodes();
                    });
                }
                
                // Bot√≥n de captura manual
                if (dom.manualCaptureBtn) {
                    dom.manualCaptureBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        captureManualImage();
                    });
                }
                
                // Controles de c√°mara
                if (dom.switchCameraBtn) {
                    dom.switchCameraBtn.addEventListener('click', (e) => { 
                        e.preventDefault(); 
                        e.stopPropagation();
                        switchCamera(); 
                    });
                }
                
                if (dom.toggleTorchBtn) {
                    dom.toggleTorchBtn.addEventListener('click', (e) => { 
                        e.preventDefault(); 
                        e.stopPropagation();
                        toggleTorch(); 
                    });
                }
                
                if (dom.closeScannerBtn) {
                    dom.closeScannerBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        stopScanning(true);
                        showMessage("Esc√°ner cerrado", 'info');
                    });
                }
                
                // Zoom slider
                if (dom.zoomSlider) {
                    dom.zoomSlider.addEventListener('input', async (e) => {
                        if (!state.currentStream || !state.zoomAvailable) return;
                        
                        try {
                            const track = state.currentStream.getVideoTracks()[0];
                            await track.applyConstraints({
                                advanced: [{ zoom: parseFloat(e.target.value) }]
                            });
                        } catch (err) {
                            console.warn("Error al ajustar zoom:", err);
                        }
                    });
                }
                 
                // Reintentar env√≠os pendientes si hay conexi√≥n
                if (navigator.onLine) {
                    setTimeout(retryPendingSubmissions, 3000);
                }
                 
                // Autosave peri√≥dico optimizado
                let autosaveTimeout;
                function scheduleAutosave() {
                    clearTimeout(autosaveTimeout);
                    autosaveTimeout = setTimeout(autosave, 15000); // 15 segundos
                }
                
                // Escuchar cambios para autosave
                document.addEventListener('input', scheduleAutosave);
                document.addEventListener('change', scheduleAutosave);
                
                // Manejar cambio de visibilidad de la p√°gina
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && state.scanning) {
                        console.log("P√°gina oculta, deteniendo escaneo para ahorrar bater√≠a");
                        stopScanning(false);
                    }
                });
                
                // Detener escaneo al salir de la p√°gina
                window.addEventListener('beforeunload', () => {
                    if (state.scanning) {
                        stopScanning(false);
                    }
                    // Limpiar OCR
                    OCRSystem.destroy();
                });
                
                // Manejar conexi√≥n/desconexi√≥n de red
                window.addEventListener('online', () => {
                    showMessage("Conexi√≥n restablecida. Reintentando env√≠os pendientes...", 'info');
                    setTimeout(retryPendingSubmissions, 2000);
                });
                
                window.addEventListener('offline', () => {
                    showMessage("Sin conexi√≥n. Los datos se guardar√°n localmente.", 'warning');
                });
                
                // Optimizar rendimiento en dispositivos m√≥viles
                if (state.deviceInfo.isAndroid) {
                    // Reducir animaciones en dispositivos lentos
                    if (state.deviceInfo.brand === 'xiaomi' || state.deviceInfo.brand === 'honor') {
                        document.body.classList.add('performance-mode');
                    }
                }
                
                console.log("Aplicaci√≥n multi-estrategia inicializada correctamente");
            }

            // Inicializar al cargar el DOM
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initApp);
            } else {
                initApp();
            }

            // Exponer funciones p√∫blicas
            return {
                mostrarFormulario: mostrarFormulario,
                agregarComponente: agregarComponente,
                enviarFormulario: enviarFormulario,
                mostrarCampos: mostrarCampos,
                stopScanning: stopScanning,
                startScanning: startScanning,
                switchCamera: switchCamera,
                toggleTorch: toggleTorch,
                captureManualImage: captureManualImage,
                enhanceImageForBlurryCodes: enhanceImageForBlurryCodes
            };
        })();
    </script>
</body>
</html>
